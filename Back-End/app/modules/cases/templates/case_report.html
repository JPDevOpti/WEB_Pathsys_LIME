<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Informe de resultados - {{ case.caso_code or case.id }}</title>
  <style>
    /* PDF Page Rules for Footer */
    @page {
      size: A4;
      margin: 2mm 15mm 20mm 15mm;
      @bottom-right {
        content: "Página " counter(page) " de " counter(pages);
        font-size: 8px;
        font-family: Arial, sans-serif;
        color: #000;
        font-weight: bold;
        margin-right: 5mm;
        white-space: nowrap;
      }
      @bottom-center {
        content: "Los informes de resultados, las placas y bloques de estudios anatomopatológicos se archivan por 15 años";
        font-size: 10px;
        font-family: Arial, sans-serif;
        color: #000;
        margin-top: 0mm;
        white-space: nowrap;
        text-align: center;
      }
    }
    @page :not(:first) {
      @top-left {
        content: "Caso N°: {{ case.caso_code or case.id }}";
        font-size: 11px;
        font-family: Arial, sans-serif;
        color: #000;
        font-weight: bold;
        margin-left: 0;
      }
      margin-top: 18mm;
    }
    
    * { box-sizing: border-box; }
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      color:#000; 
      margin:0; 
      padding:0; 
      line-height: 1.3;
    }
    .page { 
      width: 210mm; 
      min-height: 297mm; 
      padding: 2mm 15mm 20mm 15mm; 
      margin: 0 auto; 
      background: white; 
      page-break-after: always;
    }
    
    /* Additional pages with more top padding */
    .page.additional-page {
      padding: 15mm 15mm 20mm 15mm;
    }
    
    /* Page Break Rules */
    .no-break { 
      page-break-inside: avoid; 
      break-inside: avoid; 
    }
    .break-before { 
      page-break-before: always; 
      break-before: page; 
    }
    .break-after { 
      page-break-after: always; 
      break-after: page; 
    }
    
    /* Header - Never break */
    .header-container, 
    .title-bar, 
    .dept-info-container { 
      page-break-inside: avoid; 
      break-inside: avoid; 
    }
    
    /* Header Section */
    .header-container { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0; }
    .logos-section { 
      border: 2px solid #000; 
      padding: 3mm; 
      display: flex; 
      align-items: center; 
      justify-content: space-around; 
      gap: 4mm; 
      flex: 1; 
      height: 18mm;
    }
    .logo { height: 12mm; width: auto; object-fit: contain; }
    .code-box { 
      border: 2px solid #000; 
      padding: 0; 
      text-align: center; 
      font-size: 9px; 
      font-weight: bold;
      min-width: 25mm;
      height: 18mm;
      display: flex;
      flex-direction: column;
    }
    .code-row { 
      display: flex; 
      justify-content: flex-start; 
      align-items: center;
      padding: 0 3mm;
      flex: 1;
      gap: 3mm;
    }
    .code-row:first-child {
      border-bottom: 1px solid #000;
    }
    
    /* Title Bar */
    .title-bar { 
      text-align: center; 
      font-weight: bold; 
      font-size: 12px; 
      letter-spacing: 0.5px; 
      border: 2px solid #000; 
      padding: 3mm 0; 
      margin: 0; 
      background: white;
    }
    
    /* Department and Info Section */
    .dept-info-container { display: flex; gap: 0; margin: 0; }
    .dept-section { 
      flex: 1; 
      border: 2px solid #000; 
      padding: 4mm; 
    }
    .dept-header { display: flex; align-items: center; gap: 1mm; margin-bottom: 1mm; }
    .dept-icon { 
      width: 4mm; 
      height: 4mm; 
      fill: #000;
    }
    .dept-title { font-weight: bold; font-size: 11px; }
    .dept-address { font-size: 9px; line-height: 1.3; }
    
    .info-section { 
      width: 80mm; 
      border: 2px solid #000; 
      padding: 0; 
    }
    .info-header { 
      background: #f0f0f0; 
      padding: 2mm 4mm; 
      font-weight: bold; 
      font-size: 10px; 
      border-bottom: 1px solid #000; 
    }
    .info-row { 
      display: flex; 
      align-items: center;
      padding: 0.5mm 4mm; 
      border-bottom: 1px solid #ccc; 
      font-size: 9px; 
      height: 8mm;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { font-weight: bold; width: 30mm; margin-right: 2mm; }
    .info-value { flex: 1; min-height: 3mm; }
    
    /* Patient Info Table */
    .patient-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 4mm 0; 
      font-size: 10px; 
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .patient-table td { 
      padding: 2mm 3mm; 
      border-bottom: 1px solid #ccc; 
      vertical-align: top; 
    }
    .patient-label { font-weight: bold; width: 35%; }
    .patient-value { width: 65%; }
    
    /* Content Sections */
    .content-section {
      margin-bottom: 0;
    }
    
    /* Neutralize extra padding for sections detected on new page */
    .content-section.page-start { padding-top: 0; }
    .section-title { 
      font-size: 12px; 
      font-weight: bold; 
      margin: 0; 
      padding: 5mm 2mm 3mm 0;
      text-transform: uppercase; 
      page-break-after: avoid;
      break-after: avoid;
    }
    .content-box { 
      padding: 0; 
      min-height: auto; 
      max-height: none;
      font-size: 12px; 
      line-height: 1.4; 
      word-wrap: break-word; 
      overflow-wrap: anywhere; 
      white-space: pre-wrap; 
      page-break-inside: auto;
      break-inside: auto;
      margin-bottom: 0;
    }
    .content-box.large { margin-bottom: 0; }
    .content-box.small { margin-bottom: 0; }
    
    /* Sample Section */
    .sample-section {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    /* Signature Section */
    .signature-section { 
      margin-top: 8mm; 
      font-size: 10px; 
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .signature-line { 
      border-top: 1px solid #000; 
      width: 60mm; 
      margin: 6mm 0 2mm 0; 
    }
    .signature-label { font-weight: bold; }
    
    /* Footer - Alternative approach for browsers that don't support @page fully */
    .footer { 
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20mm;
      background: white;
      padding: 2mm 20mm 3mm 20mm;
      font-size: 8px; 
      color: #000; 
      z-index: 1000;
    }
    .footer-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      white-space: nowrap;
      position: relative;
    }
    .footer-note { 
      margin: 0; 
      font-size: 8px;
      white-space: nowrap;
      text-align: center;
      position: absolute;
      bottom: 3mm;
      left: 50%;
      transform: translateX(-50%);
    }
    .page-number { 
      font-weight: bold; 
      margin: 0;
      font-size: 8px;
      white-space: nowrap;
      position: absolute;
      top: 0;
      right: 0;
    }
    
    /* Hide fixed elements when @page is supported */
    @media print {
      .footer {
        display: none;
      }
      .footer-text,
      .page-counter {
        display: none;
      }
    }
    
    /* Utility Classes */
    .bold { font-weight: bold; }
    .small { font-size: 9px; }
    .center { text-align: center; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header with logos and code -->
    <div class="header-container">
      <div class="logos-section">
        <img src="http://localhost:5174/src/assets/images/Logo-LIME-NoFondo.png" alt="LIME" class="logo" />
        <img src="http://localhost:5174/src/assets/images/Banner_UDEA.png" alt="Universidad de Antioquia" class="logo" />
        <img src="http://localhost:5174/src/assets/images/Baner_HAMA.png" alt="Hospital AlmaMáter" class="logo" />
      </div>
      <div class="code-box">
        <div class="code-row">
          <span>Código:</span>
          <span>F-025-LIME</span>
        </div>
        <div class="code-row">
          <span>Versión:</span>
          <span>05</span>
        </div>
      </div>
    </div>

    <!-- Title Bar -->
    <div class="title-bar">INFORME DE RESULTADOS ANATOMOPATOLÓGICOS</div>

    <!-- Department Info and Case Info -->
    <div class="dept-info-container">
      <div class="dept-section">
        <div class="dept-header">
          <svg class="dept-icon" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
            <path d="M28.292 1.326C27.226 1.116 26.127 1 25 1c-4.71 0-8.98 1.93-12.06 5.04l6.92 5.592L28.292 1.326zM18.595 13.178L11.62 7.55C9.35 10.43 8 14.07 8 18c0 2.281.452 4.487 1.304 6.534L18.595 13.178zM22.608 11.432C23.353 11.159 24.154 11 25 11c3.87 0 7 3.13 7 7 0 .338-.032.667-.078.992l7.772-9.499c-2.058-3.539-5.348-6.268-9.285-7.595L22.608 11.432zM27.341 24.591C26.608 24.851 25.822 25 25 25c-3.87 0-7-3.13-7-7 0-.354.034-.7.084-1.039l-7.803 9.537c.386.666.809 1.315 1.289 1.932.37.5.87 1.14 1.45 1.89 1.267 1.633 2.959 3.816 4.59 6.164L27.341 24.591zM18.778 38.215c2.082 3.184 3.852 6.497 4.172 9.055.14.99.99 1.73 1.99 1.73 1.02 0 1.87-.75 1.99-1.75.61-4.83 6.57-12.48 9.78-16.6.56-.72 1.05-1.35 1.5-1.94C40.65 25.69 42 21.89 42 18c0-2.322-.471-4.536-1.319-6.555L18.778 38.215z"/>
          </svg>
          <div class="dept-title">Departamento de Patología</div>
        </div>
        <div class="dept-address">
          Hospital San Vicente Fundación<br/>
          Calle 64 Carrera 51D. Bloque 13<br/>
          Tel. 6042192400
        </div>
      </div>
      
      <div class="info-section">
        <div class="info-header">
          Informe No {{ case.caso_code or case.id }}
        </div>
        <div class="info-row">
          <span class="info-label">Fecha de Creación:</span>
          <div class="info-value">
            {% if case.fecha_creacion %}
              {% set fecha = case.fecha_creacion %}
              {% if fecha.strftime %}
                {{ fecha.strftime('%A %d de %B, %Y')|replace('Monday', 'Lunes')|replace('Tuesday', 'Martes')|replace('Wednesday', 'Miércoles')|replace('Thursday', 'Jueves')|replace('Friday', 'Viernes')|replace('Saturday', 'Sábado')|replace('Sunday', 'Domingo')|replace('January', 'enero')|replace('February', 'febrero')|replace('March', 'marzo')|replace('April', 'abril')|replace('May', 'mayo')|replace('June', 'junio')|replace('July', 'julio')|replace('August', 'agosto')|replace('September', 'septiembre')|replace('October', 'octubre')|replace('November', 'noviembre')|replace('December', 'diciembre') }}
              {% else %}
                {{ fecha[:10] }}
              {% endif %}
            {% else %}
              Haga clic aquí para escribir una fecha.
            {% endif %}
          </div>
        </div>
        <div class="info-row">
          <span class="info-label">Fecha de Informe:</span>
          <div class="info-value">
            {% if case.fecha_firma %}
              {% set fecha = case.fecha_firma %}
              {% if fecha.strftime %}
                {{ fecha.strftime('%A %d de %B, %Y')|replace('Monday', 'Lunes')|replace('Tuesday', 'Martes')|replace('Wednesday', 'Miércoles')|replace('Thursday', 'Jueves')|replace('Friday', 'Viernes')|replace('Saturday', 'Sábado')|replace('Sunday', 'Domingo')|replace('January', 'enero')|replace('February', 'febrero')|replace('March', 'marzo')|replace('April', 'abril')|replace('May', 'mayo')|replace('June', 'junio')|replace('July', 'julio')|replace('August', 'agosto')|replace('September', 'septiembre')|replace('October', 'octubre')|replace('November', 'noviembre')|replace('December', 'diciembre') }}
              {% else %}
                {{ fecha[:10] }}
              {% endif %}
            {% elif case.fecha_entrega %}
              {% set fecha = case.fecha_entrega %}
              {% if fecha.strftime %}
                {{ fecha.strftime('%A %d de %B, %Y')|replace('Monday', 'Lunes')|replace('Tuesday', 'Martes')|replace('Wednesday', 'Miércoles')|replace('Thursday', 'Jueves')|replace('Friday', 'Viernes')|replace('Saturday', 'Sábado')|replace('Sunday', 'Domingo')|replace('January', 'enero')|replace('February', 'febrero')|replace('March', 'marzo')|replace('April', 'abril')|replace('May', 'mayo')|replace('June', 'junio')|replace('July', 'julio')|replace('August', 'agosto')|replace('September', 'septiembre')|replace('October', 'octubre')|replace('November', 'noviembre')|replace('December', 'diciembre') }}
              {% else %}
                {{ fecha[:10] }}
              {% endif %}
            {% else %}
              Haga clic aquí para escribir una fecha.
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Patient Information -->
    <table class="patient-table" style="margin-top: 0; width: 100%; table-layout: fixed;">
      <tr>
        <td class="patient-label" style="width: 20%;">Paciente:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.paciente.nombre if case.paciente else '' }}</td>
        <td class="patient-label" style="width: 20%;">Documento N°:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.paciente.paciente_code if case.paciente else '' }}</td>
      </tr>
      <tr>
        <td class="patient-label" style="width: 20%;">Institución:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.paciente.entidad_info.nombre if case.paciente and case.paciente.entidad_info else 'Elija un elemento.' }}</td>
        <td class="patient-label" style="width: 20%;">Edad:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.paciente.edad if case.paciente else 'Elija un elemento.' }}</td>
      </tr>
      <tr>
        <td class="patient-label" style="width: 20%;">Servicio:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.servicio or '' }}</td>
        <td class="patient-label" style="width: 20%;">Sexo:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.paciente.sexo if case.paciente else 'Elija un elemento.' }}</td>
      </tr>
      <tr>
        <td class="patient-label" style="width: 20%;">Patólogo Asignado:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.patologo_asignado.nombre if case.patologo_asignado else '' }}</td>
        <td class="patient-label" style="width: 20%;">Médico Remitente:</td>
        <td class="patient-value" style="width: 30%; word-break: break-word;">{{ case.medico_solicitante or '' }}</td>
      </tr>
    </table>

    <!-- Sample Section -->
    <div class="content-section"><div class="section-title">MUESTRA:</div><div class="content-box">{% if case.muestras %}{{ case.muestras | map(attribute='region_cuerpo') | join(', ') }}{% endif %}</div></div>

    <!-- Method -->
    <div class="content-section"><div class="section-title">MÉTODO UTILIZADO:</div><div class="content-box">{% if case.resultado and case.resultado.metodo %}{% if case.resultado.metodo is iterable and case.resultado.metodo is not string %}{{ case.resultado.metodo|join(', ') }}{% else %}{{ case.resultado.metodo }}{% endif %}{% else %}Elija un elemento.{% endif %}</div></div>

    <!-- Macroscopic Description -->
    <div class="content-section"><div class="section-title">DESCRIPCIÓN MACROSCÓPICA</div><div class="content-box large">{% if case.resultado and case.resultado.resultado_macro %}{{ case.resultado.resultado_macro | safe }}{% else %}{% endif %}</div></div>

    <!-- Microscopic Description -->
    <div class="content-section"><div class="section-title">DESCRIPCIÓN MICROSCÓPICA</div><div class="content-box large">{% if case.resultado and case.resultado.resultado_micro %}{{ case.resultado.resultado_micro | safe }}{% else %}{% endif %}</div></div>

    <!-- Diagnosis -->
    <div class="content-section"><div class="section-title">DIAGNÓSTICO:</div><div class="content-box">{% if case.resultado and case.resultado.diagnostico %}{{ case.resultado.diagnostico | safe }}{% endif %}</div></div>

    <!-- CIE-10 -->
    {% if case.resultado and case.resultado.diagnostico_cie10 and case.resultado.diagnostico_cie10.codigo %}
    <div class="content-section"><div class="section-title">CIE-10:</div><div class="content-box">{{ case.resultado.diagnostico_cie10.codigo }} - {{ case.resultado.diagnostico_cie10.nombre }}</div></div>
    {% endif %}

    <!-- CIE-O -->
    {% if case.resultado and case.resultado.diagnostico_cieo and case.resultado.diagnostico_cieo.codigo %}
    <div class="content-section"><div class="section-title">CIE-O:</div><div class="content-box">{{ case.resultado.diagnostico_cieo.codigo }} - {{ case.resultado.diagnostico_cieo.nombre }}</div></div>
    {% endif %}

    <!-- Pruebas Complementarias -->
    {% if pruebas_complementarias and pruebas_complementarias.pruebas and pruebas_complementarias.pruebas|length > 0 %}
    <div class="content-section">
      <div class="section-title">SE NECESITAN PRUEBAS COMPLEMENTARIAS PARA COMPLETAR EL DIAGNÓSTICO:</div>
      <div style="margin: 0; padding: 0mm; line-height: 1.6; font-size: 12px;">
        <strong>Pruebas solicitadas:</strong><br/>
        {% for test in pruebas_complementarias.pruebas %}
          {% if test.codigo and test.nombre %}
          • {{ test.codigo }} - {{ test.nombre }}{% if test.cantidad and test.cantidad > 1 %} (Cantidad: {{ test.cantidad }}){% endif %}<br/>
          {% endif %}
        {% endfor %}
        {% if pruebas_complementarias.motivo %}
        <br/><strong>Motivo:</strong> {{ pruebas_complementarias.motivo }}
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <!-- Additional Notes -->
    {% if case.notas_adicionales and case.notas_adicionales|length > 0 %}
    <div class="content-section">
      <div class="section-title">NOTAS ADICIONALES:</div>
      <div style="margin: 0; padding: 0; line-height: 1.6; font-size: 12px;">
        {% for nota in case.notas_adicionales %}
        {% if nota.date %}
          {% set fecha = nota.date %}
          {% if fecha.strftime %}
            <strong>{{ fecha.strftime('%d/%m/%Y') }}</strong>
          {% else %}
            <strong>{{ fecha[:10] }}</strong>
          {% endif %}
        {% endif %}
        : {{ nota.note }}{% if not loop.last %}<br/>{% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Signature -->
    <div class="signature-section">
      {% if pathologist_signature %}
      <img src="{{ pathologist_signature }}" alt="Firma del patólogo" style="height: 15mm; width: auto; object-fit: contain; display: block;"/>
      {% endif %}
      <div class="signature-line"></div>
      <div><span class="signature-label">Médico Patólogo:</span> {{ case.patologo_asignado.nombre if case.patologo_asignado else '' }}</div>
    </div>
  </div>

  <!-- Footer for all pages -->
  <div class="footer">
    <div class="footer-content">
      <div class="page-number">Página 1 de 1</div>
      <div class="footer-note">Los informes de resultados, las placas y bloques de estudios anatomopatológicos se archivan por 15 años</div>
    </div>
  </div>

  
</body>
</html>
