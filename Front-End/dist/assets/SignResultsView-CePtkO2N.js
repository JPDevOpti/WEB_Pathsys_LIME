var qe=Object.defineProperty;var Je=(D,t,o)=>t in D?qe(D,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):D[t]=o;var xe=(D,t,o)=>Je(D,typeof t!="symbol"?t+"":t,o);import{b as v,e as g,h as e,r as k,d as ue,c as P,k as ie,o as De,g as C,i as M,t as E,y as Ce,z as we,I as ce,u as r,f as x,F as Qe,l as We,q as Ie,C as Ge,a as Xe,j as G,w as ae,p as es,K as ss}from"./index-CAHFE_9E.js";import{a as O,u as as,D as ts,b as os}from"./PathologistList.vue_vue_type_style_index_0_scoped_45f5ffeb_lang-FwbajLSj.js";import{C as de,_ as rs}from"./DiseaseList.vue_vue_type_style_index_0_scoped_2e8ef3ac_lang-CSxq79ax.js";import{_ as ls,a as ns}from"./SearchButton.vue_vue_type_script_setup_true_lang-y2wCoroa.js";/* empty css                                                                   */import{_ as Ee,a as is}from"./ClearButton.vue_vue_type_script_setup_true_lang-iqMnWNPk.js";import{_ as ds}from"./PreviewButton.vue_vue_type_script_setup_true_lang-CTpBWkFw.js";import{_ as cs}from"./ErrorMessage.vue_vue_type_script_setup_true_lang-B0NY5YZD.js";import{a as us}from"./Notification.vue_vue_type_script_setup_true_lang-Dr_eoe6-.js";import{_ as ms}from"./ValidationAlert.vue_vue_type_script_setup_true_lang-CKSrl8Ug.js";import{c as ke}from"./casesApi.service-DwGpQD03.js";import{u as gs}from"./useNotifications-DFiSmdMU.js";import{_ as ps}from"./FormCheckbox.vue_vue_type_script_setup_true_lang-DxUtxK1N.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as fs,d as vs,_ as hs,a as bs,b as ys,c as _s,r as xs}from"./usePerformResults-DiQBAVlc.js";import"./UserCircleIcon-DNVwMiGR.js";const Cs={},ws={className:"fill-current",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function Es(D,t){return g(),v("svg",ws,[...t[0]||(t[0]=[e("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M20.3499 12.0004C20.3499 16.612 16.6115 20.3504 11.9999 20.3504C7.38832 20.3504 3.6499 16.612 3.6499 12.0004C3.6499 7.38881 7.38833 3.65039 11.9999 3.65039C16.6115 3.65039 20.3499 7.38881 20.3499 12.0004ZM11.9999 22.1504C17.6056 22.1504 22.1499 17.6061 22.1499 12.0004C22.1499 6.3947 17.6056 1.85039 11.9999 1.85039C6.39421 1.85039 1.8499 6.3947 1.8499 12.0004C1.8499 17.6061 6.39421 22.1504 11.9999 22.1504ZM13.0008 16.4753C13.0008 15.923 12.5531 15.4753 12.0008 15.4753L11.9998 15.4753C11.4475 15.4753 10.9998 15.923 10.9998 16.4753C10.9998 17.0276 11.4475 17.4753 11.9998 17.4753L12.0008 17.4753C12.5531 17.4753 13.0008 17.0276 13.0008 16.4753ZM11.9998 6.62898C12.414 6.62898 12.7498 6.96476 12.7498 7.37898L12.7498 13.0555C12.7498 13.4697 12.414 13.8055 11.9998 13.8055C11.5856 13.8055 11.2498 13.4697 11.2498 13.0555L11.2498 7.37898C11.2498 6.96476 11.5856 6.62898 11.9998 6.62898Z",fill:"currentColor"},null,-1)])])}const ks=me(Cs,[["render",Es]]),$s={},Ds={width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function Is(D,t){return g(),v("svg",Ds,[...t[0]||(t[0]=[e("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M3.6501 12.0001C3.6501 7.38852 7.38852 3.6501 12.0001 3.6501C16.6117 3.6501 20.3501 7.38852 20.3501 12.0001C20.3501 16.6117 16.6117 20.3501 12.0001 20.3501C7.38852 20.3501 3.6501 16.6117 3.6501 12.0001ZM12.0001 1.8501C6.39441 1.8501 1.8501 6.39441 1.8501 12.0001C1.8501 17.6058 6.39441 22.1501 12.0001 22.1501C17.6058 22.1501 22.1501 17.6058 22.1501 12.0001C22.1501 6.39441 17.6058 1.8501 12.0001 1.8501ZM10.9992 7.52517C10.9992 8.07746 11.4469 8.52517 11.9992 8.52517H12.0002C12.5525 8.52517 13.0002 8.07746 13.0002 7.52517C13.0002 6.97289 12.5525 6.52517 12.0002 6.52517H11.9992C11.4469 6.52517 10.9992 6.97289 10.9992 7.52517ZM12.0002 17.3715C11.586 17.3715 11.2502 17.0357 11.2502 16.6215V10.945C11.2502 10.5308 11.586 10.195 12.0002 10.195C12.4144 10.195 12.7502 10.5308 12.7502 10.945V16.6215C12.7502 17.0357 12.4144 17.3715 12.0002 17.3715Z",fill:"currentColor"},null,-1)])])}const $e=me($s,[["render",Is]]);class Ss{constructor(){xe(this,"endpoint","/enfermedades")}async searchDiseasesByTabla(t,o=15e3){var m,l;try{const f=await O.get(`${this.endpoint}/tabla/${t}`,{params:{limit:o,skip:0}}),_=f.data||f;return{diseases:_.enfermedades||[],total:_.total||0,page:1,limit:_.limit||o}}catch(f){throw new Error(((l=(m=f.response)==null?void 0:m.data)==null?void 0:l.message)||"Error al buscar enfermedades por tabla")}}async searchDiseases(t,o=15e3){var m,l,f,_;try{if(/^[A-Z]\d{2,3}$/.test(t.toUpperCase())){const y=await O.get(`${this.endpoint}/search/codigo`,{params:{q:t,limit:o,skip:0}}),d=y.data||y;return{diseases:d.enfermedades||[],total:((m=d.enfermedades)==null?void 0:m.length)||0,page:1,limit:d.limit||o}}const i=await O.get(`${this.endpoint}/search/nombre`,{params:{q:t,limit:o,skip:0}}),c=i.data||i;return{diseases:c.enfermedades||[],total:((l=c.enfermedades)==null?void 0:l.length)||0,page:1,limit:c.limit||o}}catch(i){throw new Error(((_=(f=i.response)==null?void 0:f.data)==null?void 0:_.message)||"Error al buscar enfermedades")}}async getAllDiseases(){var t,o;try{const m=await O.get(`${this.endpoint}`,{params:{skip:0,limit:1,is_active:!0}}),f=(m.data||m).total||12634,_=await O.get(`${this.endpoint}`,{params:{skip:0,limit:f,is_active:!0}}),i=_.data||_;return{diseases:i.enfermedades||[],total:i.total||f,page:1,limit:i.limit||f}}catch(m){throw new Error(((o=(t=m.response)==null?void 0:t.data)==null?void 0:o.message)||"Error al obtener enfermedades")}}async getDiseaseById(t){var o,m;try{return(await O.get(`${this.endpoint}/${t}`)).data}catch(l){throw new Error(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.message)||"Enfermedad no encontrada")}}async getDiseaseByCode(t){var o,m;try{return(await O.get(`${this.endpoint}/codigo/${t}`)).data}catch(l){throw new Error(((m=(o=l.response)==null?void 0:o.data)==null?void 0:m.message)||"Enfermedad no encontrada")}}async getDiseasesByTable(t,o=1,m=50){var l,f,_;try{const c=(await O.get(`${this.endpoint}/tabla/${t}`,{params:{skip:(o-1)*m,limit:m}})).data;return{data:c.enfermedades||[],total:((l=c.enfermedades)==null?void 0:l.length)||0,page:o,limit:c.limit||m}}catch(i){throw new Error(((_=(f=i.response)==null?void 0:f.data)==null?void 0:_.message)||"Error al obtener enfermedades por tabla")}}async createDisease(t){throw new Error("No implementado en el frontend")}async updateDisease(t,o){throw new Error("No implementado en el frontend")}async deleteDisease(t){throw new Error("No implementado en el frontend")}async searchByName(t,o=15e3){return this.searchDiseases(t,o)}async searchByCode(t,o=15e3){return this.searchDiseases(t,o)}}const A=new Ss;function Bs(){const D=k([]),t=k(!1),o=k("");return{diseases:D,isLoading:t,error:o,loadDiseases:async()=>{var i,c,y,d,w;t.value=!0,o.value="";try{const p=await A.getAllDiseases();return D.value=p.diseases,{success:!0,diseases:p.diseases,message:"Enfermedades cargadas exitosamente"}}catch(p){let b="Error al cargar enfermedades";return((i=p.response)==null?void 0:i.status)===307?b="Error de redirección en el servidor. Verificar configuración de endpoints.":(y=(c=p.response)==null?void 0:c.data)!=null&&y.detail?b=`Error de validación: ${JSON.stringify(p.response.data.detail)}`:(w=(d=p.response)==null?void 0:d.data)!=null&&w.message?b=p.response.data.message:p.message&&(b=p.message),o.value=b,{success:!1,error:b}}finally{t.value=!1}},searchDiseases:async(i,c,y=15e3)=>{var d,w;t.value=!0,o.value="";try{let p;if(c&&c.trim())if(c==="CIEO"){if(p=await A.searchDiseasesByTabla("CIEO",y),i&&i.trim()){const b=p.diseases.filter(I=>I.nombre.toLowerCase().includes(i.toLowerCase())||I.codigo.toLowerCase().includes(i.toLowerCase()));p.diseases=b,p.total=b.length}}else if(c==="CIE10"){if(p=await A.searchDiseasesByTabla("CIE10",y),i&&i.trim()){const b=p.diseases.filter(I=>I.nombre.toLowerCase().includes(i.toLowerCase())||I.codigo.toLowerCase().includes(i.toLowerCase()));p.diseases=b,p.total=b.length}}else p=await A.searchDiseases(i,y);else p=await A.searchDiseases(i,y);return{success:!0,diseases:p.diseases,message:"Búsqueda completada"}}catch(p){const b=((w=(d=p.response)==null?void 0:d.data)==null?void 0:w.message)||p.message||"Error en la búsqueda";return o.value=b,{success:!1,error:b}}finally{t.value=!1}},getDiseaseById:async i=>{var c,y;t.value=!0,o.value="";try{return{success:!0,diseases:[await A.getDiseaseById(i)],message:"Enfermedad encontrada"}}catch(d){const w=((y=(c=d.response)==null?void 0:c.data)==null?void 0:y.message)||d.message||"Error al obtener enfermedad";return o.value=w,console.error("Error al obtener enfermedad por ID:",d),{success:!1,error:w}}finally{t.value=!1}},getDiseaseByCode:async i=>{var c,y;t.value=!0,o.value="";try{return{success:!0,diseases:[await A.getDiseaseByCode(i)],message:"Enfermedad encontrada"}}catch(d){const w=((y=(c=d.response)==null?void 0:c.data)==null?void 0:y.message)||d.message||"Error al obtener enfermedad";return o.value=w,console.error("Error al obtener enfermedad por código:",d),{success:!1,error:w}}finally{t.value=!1}}}}const Ns={class:"disease-selector"},Ls={key:0,class:"block text-sm font-medium text-gray-700 mb-1"},Os={key:0,class:"text-red-500 ml-1"},Ms={class:"mb-4"},Vs={class:"flex gap-2"},As=["placeholder","disabled"],Ps=["disabled"],zs={key:0,class:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24"},Rs={key:1},Ts={class:"mb-4"},js={key:1,class:"mb-4"},Us={class:"flex gap-2"},Zs=["disabled"],Fs=["disabled"],Ys={key:0,class:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24"},Ks={key:1},Hs={key:2,class:"mb-4 space-y-3"},qs={key:0,class:"p-3 bg-blue-50 border border-blue-200 rounded-lg"},Js={class:"text-xs text-blue-800"},Qs={class:"font-medium"},Ws={key:1,class:"p-3 bg-blue-50 border border-blue-200 rounded-lg"},Gs={class:"text-xs text-blue-800"},Xs={class:"font-medium"},ea={key:3,class:"border border-gray-300 rounded-lg overflow-hidden"},sa={class:"max-h-60 overflow-y-auto"},aa={class:"w-full"},ta={class:"bg-white divide-y divide-gray-200"},oa=["onClick"],ra={class:"px-3 py-2 text-sm"},la={class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"},na={class:"px-3 py-2 text-sm text-gray-900"},ia={class:"px-3 py-2 text-sm"},da={class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"},ca={class:"px-3 py-2 text-sm"},ua=["onClick"],ma={class:"px-3 py-2 bg-gray-50 border-t border-gray-200 text-xs text-gray-500"},ga={key:4,class:"text-center py-8 text-gray-500"},pa={key:5,class:"mt-1 text-xs text-gray-500"},fa={key:6,class:"mt-1 text-sm text-red-600"},va={key:7,class:"mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg"},ha=ue({__name:"DiseaseList",props:{modelValue:{default:null},label:{default:""},placeholder:{default:"Buscar enfermedad CIE-10..."},required:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},helpText:{default:""},errors:{default:()=>[]},autoLoad:{type:Boolean,default:!1}},emits:["update:modelValue","disease-selected","cieo-disease-selected","load-error","load-success"],setup(D,{emit:t}){const o=D,m=t,{searchDiseases:l,isLoading:f}=Bs(),_=k(""),i=k(""),c=k([]),y=k(!1),d=k(""),w=k(!1),p=k(o.modelValue),b=k(null),I=P(()=>p.value||o.modelValue),S=P(()=>Array.isArray(o.errors)?o.errors.join(", "):""),R=async()=>{if(!(!_.value.trim()||o.disabled)){y.value=!0;try{const u=await l(_.value,"CIE10");u.success?c.value=u.diseases||[]:(c.value=[],d.value=u.error||"Error al buscar enfermedades")}catch{c.value=[],d.value="Error al buscar enfermedades"}}},T=async()=>{if(!(!i.value.trim()||o.disabled)){y.value=!0;try{const u=await l(i.value,"CIEO");u.success?c.value=u.diseases||[]:(c.value=[],d.value=u.error||"Error al buscar enfermedades")}catch{c.value=[],d.value="Error al buscar enfermedades"}}},j=u=>{u.tabla==="CIEO"?(b.value=u,m("cieo-disease-selected",u)):(p.value=u,m("update:modelValue",u),m("disease-selected",u)),c.value=[],y.value=!1},X=async()=>{try{d.value=""}catch{const n="Error al cargar la lista de enfermedades";d.value=n,m("load-error",n)}};return ie(()=>o.modelValue,u=>{p.value=u||null},{immediate:!0}),ie(p,u=>{u!==o.modelValue&&m("update:modelValue",u)}),ie(w,u=>{u||(b.value=null,m("cieo-disease-selected",null))}),De(async()=>{}),(u,n)=>(g(),v("div",Ns,[u.label?(g(),v("label",Ls,[M(E(u.label)+" ",1),u.required?(g(),v("span",Os,"*")):C("",!0)])):C("",!0),e("div",Ms,[e("div",Vs,[Ce(e("input",{"onUpdate:modelValue":n[0]||(n[0]=$=>_.value=$),type:"text",placeholder:u.placeholder,disabled:u.disabled||r(f),class:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-colors bg-white",onKeydown:ce(R,["enter"]),autocomplete:"off"},null,40,As),[[we,_.value]]),e("button",{onClick:R,disabled:u.disabled||r(f)||!_.value.trim(),class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[r(f)?(g(),v("svg",zs,[...n[3]||(n[3]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(g(),v("span",Rs,"Buscar"))],8,Ps)])]),e("div",Ts,[x(r(ps),{modelValue:w.value,"onUpdate:modelValue":n[1]||(n[1]=$=>w.value=$),label:"Incluir diagnóstico de cáncer (CIEO)",id:"cieo-checkbox"},null,8,["modelValue"])]),w.value?(g(),v("div",js,[n[5]||(n[5]=e("label",{class:"block text-xs font-medium text-gray-600 mb-2"},"Diagnóstico de cáncer:",-1)),e("div",Us,[Ce(e("input",{"onUpdate:modelValue":n[2]||(n[2]=$=>i.value=$),type:"text",placeholder:"Buscar cáncer CIEO...",disabled:u.disabled||r(f),class:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-colors bg-white",onKeydown:ce(T,["enter"]),autocomplete:"off"},null,40,Zs),[[we,i.value]]),e("button",{onClick:T,disabled:u.disabled||r(f)||!i.value.trim(),class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[r(f)?(g(),v("svg",Ys,[...n[4]||(n[4]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(g(),v("span",Ks,"Buscar"))],8,Fs)])])):C("",!0),I.value||b.value?(g(),v("div",Hs,[I.value?(g(),v("div",qs,[n[6]||(n[6]=e("h4",{class:"text-sm font-medium text-blue-900 mb-2"},"Diagnóstico CIE-10 Seleccionado",-1)),e("div",Js,[e("span",Qs,E(I.value.codigo),1),M(" - "+E(I.value.nombre),1)])])):C("",!0),b.value?(g(),v("div",Ws,[n[7]||(n[7]=e("h4",{class:"text-sm font-medium text-blue-900 mb-2"},"Diagnóstico CIEO Seleccionado",-1)),e("div",Gs,[e("span",Xs,E(b.value.codigo),1),M(" - "+E(b.value.nombre),1)])])):C("",!0)])):C("",!0),c.value.length>0?(g(),v("div",ea,[e("div",sa,[e("table",aa,[n[8]||(n[8]=e("thead",{class:"bg-gray-50 sticky top-0"},[e("tr",null,[e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Código"),e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Nombre"),e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Tabla"),e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Acción")])],-1)),e("tbody",ta,[(g(!0),v(Qe,null,We(c.value,$=>(g(),v("tr",{key:$.id,class:"hover:bg-gray-50 cursor-pointer",onClick:te=>j($)},[e("td",ra,[e("span",la,E($.codigo),1)]),e("td",na,E($.nombre),1),e("td",ia,[e("span",da,E($.tabla),1)]),e("td",ca,[e("button",{onClick:Ie(te=>j($),["stop"]),class:"text-blue-600 hover:text-blue-800 font-medium"}," Seleccionar ",8,ua)])],8,oa))),128))])])]),e("div",ma,E(c.value.length)+" resultado"+E(c.value.length!==1?"s":"")+" encontrado"+E(c.value.length!==1?"s":""),1)])):y.value&&!r(f)?(g(),v("div",ga,[...n[9]||(n[9]=[e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1),e("p",{class:"mt-2"},"No se encontraron enfermedades",-1)])])):C("",!0),u.helpText?(g(),v("p",pa,E(u.helpText),1)):C("",!0),S.value?(g(),v("p",fa,E(S.value),1)):C("",!0),d.value?(g(),v("div",va,[e("div",{class:"flex items-center"},[n[11]||(n[11]=e("svg",{class:"w-5 h-5 text-amber-600 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("div",null,[n[10]||(n[10]=e("p",{class:"text-sm text-amber-800"},"No se pudieron cargar las enfermedades.",-1)),e("button",{onClick:X,class:"mt-1 text-sm text-amber-700 hover:text-amber-800 underline font-medium"}," Intentar cargar nuevamente ")])])])):C("",!0)]))}}),ba=me(ha,[["__scopeId","data-v-2e8ef3ac"]]),ya={class:"space-y-6"},_a={class:"grid grid-cols-1 lg:grid-cols-3 gap-6 items-start"},xa={class:"flex items-center justify-between mb-2"},Ca={key:0,class:"text-sm text-gray-500"},wa={key:0,class:"text-blue-600"},Ea={key:1,class:"text-orange-600 italic"},ka={class:"bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200 mb-4"},$a={class:"flex flex-col md:flex-row gap-3 md:gap-4 items-stretch md:items-end"},Da={class:"flex-1"},Ia={key:0,class:"mt-1 text-xs text-red-600"},Sa={class:"flex gap-2 md:gap-3"},Ba={key:0,class:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg"},Na={class:"flex items-center"},La={class:"text-sm text-red-600"},Oa={class:"flex-1 flex flex-col min-h-0 mt-0"},Ma={class:"mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200"},Va={class:"text-sm font-semibold text-gray-700 mb-3 flex items-center"},Aa={class:"mb-4"},Pa={key:1,class:"mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg"},za={class:"flex items-center"},Ra={key:2,class:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg"},Ta={class:"flex items-center"},ja={class:"text-sm text-red-700"},Ua={key:3,class:"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg"},Za={class:"flex items-center"},Fa={class:"text-sm text-yellow-700"},Ya={class:"mt-3 flex flex-wrap items-center gap-3 justify-end"},Ka={class:"space-y-6"},Ha=ue({__name:"SignResults",props:{sampleId:{},autoSearch:{type:Boolean}},setup(D){const t=D,{loading:o,patient:m,caseDetails:l,activeSection:f,errorMessage:_,validationMessage:i,initialize:c,previousCases:y,sections:d,canSave:w,onClear:p,clearAfterSuccess:b,loadCaseByCode:I,primaryDiseaseCIEO:S,hasDiseaseCIEO:R,showCIEODiagnosis:T,setPrimaryDiseaseCIEO:j,clearPrimaryDiseaseCIEO:X}=fs(t.sampleId),{isPatologo:u}=as(),n=Ge(),{notification:$,showSuccess:te,showError:U,closeNotification:Se}=gs(),{primaryDisease:Z,hasDisease:ge,setPrimaryDisease:pe,clearDiagnosis:fe,formatDiagnosisForReport:Be,getDiagnosisData:Ne,validateDiagnosis:Le}=vs(),Oe=es();De(()=>{c(),t.autoSearch&&t.sampleId&&Me();const s=()=>{_e()};window.addEventListener("clear-search",s),Xe(()=>{window.removeEventListener("clear-search",s)})});const Me=async()=>{t.sampleId&&(B.value=t.sampleId,await ne())},oe=k(!1),F=k(!1),re=P(()=>{var h,N;if(!((N=(h=l.value)==null?void 0:h.patologo_asignado)!=null&&N.nombre)||!n.user)return!1;const s=l.value.patologo_asignado.nombre,a=ye();return s===a}),ve=s=>s&&s.toUpperCase().replace(/\s+/g,"_"),le=P(()=>{var a;return(a=l.value)!=null&&a.estado?ve(l.value.estado)!=="COMPLETADO":!1}),he=P(()=>{var h;if(!((h=l.value)!=null&&h.estado))return"";const s=l.value.estado;return ve(s)==="COMPLETADO"?"Este caso ya ha sido completado y firmado.":""}),B=k(""),ee=k(!1),z=k(!1),V=k(""),Y=k(null),be=s=>!s||typeof s!="string"||s.trim()===""?!1:/^\d{4}-\d{5}$/.test(s.trim()),ye=()=>{if(!n.user)return null;let s=n.user.username||n.user.nombre||n.user.nombres||n.user.nombre_completo||n.user.full_name||null;if(!s&&(n.user.nombres||n.user.apellidos)){const a=n.user.nombres||"",h=n.user.apellidos||"";s=`${a} ${h}`.trim()}if(!s&&(n.user.first_name||n.user.last_name)){const a=n.user.first_name||"",h=n.user.last_name||"";s=`${a} ${h}`.trim()}return s},Ve=s=>s!=null&&s.patologo_asignado&&(s.patologo_asignado.nombre||s.patologo_asignado.nombres||s.patologo_asignado.nombre_completo)||null,Ae=s=>{s=s.replace(/[^\d-]/g,""),s=s.slice(0,10),s.length>=4&&!s.includes("-")&&(s=s.slice(0,4)+"-"+s.slice(4));const a=s.split("-");if(a.length>2&&(s=a[0]+"-"+a.slice(1).join("")),s.includes("-")&&s.indexOf("-")!==4){const h=s.replace(/-/g,"");h.length>=4?s=h.slice(0,4)+"-"+h.slice(4,9):s=h}B.value=s},ne=async()=>{if(!B.value.trim()){V.value="Por favor, ingrese un código de caso";return}if(!be(B.value)){V.value="El código debe tener el formato YYYY-NNNNN (Ejemplo: 2025-00001)";return}ee.value=!0,V.value="",z.value=!1;try{const s=await ke.getCaseByCode(B.value.trim());if(u.value&&n.user){const a=Ve(s),h=ye();if(!a)throw new Error("Este caso no tiene un patólogo asignado.");if(!h)throw new Error("No se pudo identificar tu nombre de usuario. Contacta al administrador.");if(a!==h)throw new Error("No tienes permisos para acceder a este caso. Solo puedes acceder a casos donde estés asignado como patólogo.")}z.value=!0,await I(B.value.trim()),await Pe(s)}catch(s){z.value=!1,V.value=s.message||"Error al buscar el caso"}finally{ee.value=!1}},Pe=async s=>{try{if(s.resultado){const a=s.resultado;if(a.diagnostico_cie10){const h={id:a.diagnostico_cie10.id,codigo:a.diagnostico_cie10.codigo,nombre:a.diagnostico_cie10.nombre,tabla:"CIE-10",isActive:!0};pe(h)}if(a.diagnostico_cieo){const h={id:a.diagnostico_cieo.id,codigo:a.diagnostico_cieo.codigo,nombre:a.diagnostico_cieo.nombre,tabla:"CIE-O",isActive:!0};j(h),T.value=!0}}}catch(a){console.warn("Error al cargar diagnósticos existentes:",a)}},_e=()=>{B.value="",z.value=!1,V.value="",F.value=!1,fe(),X(),T.value=!1};function ze(){p(),fe(),X()}function Re(){var a;const s={sampleId:((a=l==null?void 0:l.value)==null?void 0:a.CasoCode)||t.sampleId,patient:(m==null?void 0:m.value)||null,caseDetails:(l==null?void 0:l.value)||null,sections:(d==null?void 0:d.value)||null,diagnosis:{cie10:Ne(),cieo:R.value&&S.value?{id:S.value.id,codigo:S.value.codigo,nombre:S.value.nombre}:void 0,formatted:Be()},generatedAt:new Date().toISOString()};try{sessionStorage.setItem("results_preview_payload",JSON.stringify(s))}catch{}Oe.push({name:"results-preview"})}async function Te(){var s,a,h,N,K,H,q,J,Q;try{oe.value=!0;const L=Le();if(!L.isValid){i.value=L.errors.join(", ");return}if(!re.value){U("No autorizado","Solo el patólogo asignado al caso puede firmar este resultado.",0);return}if(!le.value&&!F.value){U("Estado no válido",he.value,0);return}const W=(a=(s=l==null?void 0:l.value)==null?void 0:s.patologo_asignado)==null?void 0:a.codigo;if(!W){U("Error al firmar","No se pudo identificar el patólogo asignado al caso.",0);return}const se=((h=l==null?void 0:l.value)==null?void 0:h.CasoCode)||t.sampleId,Ye=ge.value&&Z.value?{id:Z.value.id,codigo:Z.value.codigo,nombre:Z.value.nombre}:void 0,Ke=R.value&&S.value?{id:S.value.id,codigo:S.value.codigo,nombre:S.value.nombre}:void 0,He={metodo:((N=d.value)==null?void 0:N.method)||"",resultado_macro:((K=d.value)==null?void 0:K.macro)||"",resultado_micro:((H=d.value)==null?void 0:H.micro)||"",diagnostico:((q=d.value)==null?void 0:q.diagnosis)||"",observaciones:"",diagnostico_cie10:Ye,diagnostico_cieo:Ke};await xs.firmarResultado(se,He,W)?(te("¡Resultado firmado exitosamente!",`El resultado del caso ${se} ha sido firmado y está listo para entrega.`,0),i.value="",l.value&&(l.value.estado="COMPLETADO"),F.value=!0,b()):U("Error al firmar","El servidor no devolvió una respuesta válida.",0)}catch(L){U("Error al firmar",((Q=(J=L.response)==null?void 0:J.data)==null?void 0:Q.message)||L.message||"No se pudo firmar el resultado.",0)}finally{oe.value=!1}}const je=s=>{pe(s),s&&(i.value="")},Ue=s=>{j(s),s&&(i.value="")},Ze=s=>{d.value&&(d.value[f.value]=s)},Fe=async s=>{try{const a=await ke.getCaseByCode(s.CasoCode);Y.value=a}catch{Y.value=s}};return(s,a)=>(g(),v("div",ya,[e("div",_a,[x(r(de),{class:"lg:col-span-2 min-h-[640px] flex flex-col",dense:!1,fullHeight:!0},{default:ae(()=>{var h,N,K,H,q,J,Q,L,W;return[e("div",xa,[a[4]||(a[4]=e("h2",{class:"text-lg font-semibold"},"Firmar Resultados",-1)),(h=r(l))!=null&&h.CasoCode?(g(),v("div",Ca,[a[2]||(a[2]=e("span",{class:"font-medium"},"Caso:",-1)),M(" "+E(r(l).CasoCode)+" ",1),a[3]||(a[3]=e("span",{class:"mx-2"},"-",-1)),(N=r(l).patologo_asignado)!=null&&N.nombre?(g(),v("span",wa,E(r(l).patologo_asignado.nombre),1)):(g(),v("span",Ea," Sin patólogo asignado "))])):C("",!0)]),e("div",ka,[a[6]||(a[6]=e("h3",{class:"text-sm font-semibold text-gray-700 mb-3 flex items-center"},[e("svg",{class:"w-4 h-4 mr-2 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})]),M(" Buscar Caso ")],-1)),e("div",$a,[e("div",Da,[x(r(ls),{id:"codigo-caso","model-value":B.value,"onUpdate:modelValue":Ae,type:"text",placeholder:"Ej: 2025-00001",maxlength:"10",autocomplete:"off",disabled:ee.value,onKeydown:ce(Ie(ne,["prevent"]),["enter"]),class:"flex-1"},null,8,["model-value","disabled","onKeydown"]),B.value&&!be(B.value)?(g(),v("div",Ia," El código debe tener el formato YYYY-NNNNN (Ejemplo: 2025-00001) ")):C("",!0)]),e("div",Sa,[z.value?C("",!0):(g(),G(r(ns),{key:0,text:"Buscar","loading-text":"Buscando...",loading:ee.value,onClick:ne,size:"md",variant:"primary"},null,8,["loading"])),z.value?(g(),G(r(Ee),{key:1,text:"Limpiar",onClick:_e})):C("",!0)])]),V.value?(g(),v("div",Ba,[e("div",Na,[a[5]||(a[5]=e("svg",{class:"w-5 h-5 text-red-500 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("p",La,E(V.value),1)])])):C("",!0)]),e("div",Oa,[x(hs,{class:"flex-1 min-h-0","model-value":r(d)[r(f)],"onUpdate:modelValue":Ze,"active-section":r(f),"onUpdate:activeSection":a[0]||(a[0]=se=>f.value=se),sections:r(d)},null,8,["model-value","active-section","sections"]),e("div",Ma,[e("h3",Va,[x(ts,{class:"w-4 h-4 mr-2 text-gray-500"}),a[7]||(a[7]=M(" Diagnóstico ",-1))]),e("div",Aa,[x(r(ba),{"model-value":r(Z),"onUpdate:modelValue":je,onCieoDiseaseSelected:Ue,label:"Diagnóstico CIE-10",placeholder:"Buscar enfermedad CIE-10...",required:!0},null,8,["model-value"])])]),x(r(ms),{visible:!!r(i),class:"mt-2",errors:r(i)?[r(i)]:[]},null,8,["visible","errors"]),r(_)?(g(),G(r(cs),{key:0,class:"mt-2",message:r(_)},null,8,["message"])):C("",!0),(K=r(l))!=null&&K.CasoCode&&!((H=r(l).patologo_asignado)!=null&&H.nombre)?(g(),v("div",Pa,[e("div",za,[x($e,{class:"w-5 h-5 text-orange-500 mr-2 flex-shrink-0"}),a[8]||(a[8]=e("div",null,[e("p",{class:"text-sm font-medium text-orange-800"},"Patólogo no asignado"),e("p",{class:"text-sm text-orange-700"},"Este caso aún no tiene un patólogo asignado. Contacta al auxiliar administrativo para asignar un patólogo antes de firmar.")],-1))])])):C("",!0),(q=r(l))!=null&&q.CasoCode&&((J=r(l).patologo_asignado)!=null&&J.nombre)&&!re.value?(g(),v("div",Ra,[e("div",Ta,[x(ks,{class:"w-5 h-5 text-red-500 mr-2 flex-shrink-0"}),e("div",null,[a[11]||(a[11]=e("p",{class:"text-sm font-medium text-red-800"},"No eres el patólogo asignado",-1)),e("p",ja,[a[9]||(a[9]=M("Este caso está asignado a ",-1)),e("strong",null,E(r(l).patologo_asignado.nombre),1),a[10]||(a[10]=M(". Solo el patólogo asignado puede firmar este resultado.",-1))])])])])):C("",!0),(Q=r(l))!=null&&Q.CasoCode&&!le.value&&!F.value?(g(),v("div",Ua,[e("div",Za,[x($e,{class:"w-5 h-5 text-yellow-500 mr-2 flex-shrink-0"}),e("div",null,[a[12]||(a[12]=e("p",{class:"text-sm font-medium text-yellow-800"},"Estado no válido para firmar",-1)),e("p",Fa,E(he.value),1)])])])):C("",!0),e("div",Ya,[x(r(Ee),{disabled:r(o),onClick:ze},null,8,["disabled"]),x(r(ds),{disabled:r(o),onClick:Re},null,8,["disabled"]),x(r(is),{disabled:r(o)||!r(w)||!r(ge)||!((W=(L=r(l))==null?void 0:L.patologo_asignado)!=null&&W.nombre)||!re.value||!le.value&&!F.value,loading:oe.value,text:"Firmar","loading-text":"Firmando...",onClick:Te},null,8,["disabled","loading"])]),x(us,{class:"mt-3",visible:r($).visible,type:r($).type,title:r($).title,message:r($).message,inline:!0,"auto-close":!1,"data-notification":"success",onClose:r(Se)},null,8,["visible","type","title","message","onClose"])])]}),_:1}),e("div",Ka,[x(r(de),null,{default:ae(()=>[x(bs,{patient:r(m),loading:r(o),"previous-cases":r(y),onCaseClick:Fe},null,8,["patient","loading","previous-cases"])]),_:1}),x(r(de),null,{default:ae(()=>[x(ys,{details:r(l),loading:r(o)},null,8,["details","loading"])]),_:1})])]),Y.value?(g(),G(_s,{key:0,"case-item":Y.value,onClose:a[1]||(a[1]=h=>Y.value=null)},null,8,["case-item"])):C("",!0)]))}}),qa="Firmar Resultados",gt=ue({__name:"SignResultsView",setup(D){const t=ss(),o=P(()=>t.query.muestraId||t.query.case||""),m=P(()=>t.query.auto==="1"&&!!o.value);return(l,f)=>(g(),G(r(os),null,{default:ae(()=>[x(rs,{pageTitle:qa}),x(Ha,{"sample-id":o.value,"auto-search":m.value},null,8,["sample-id","auto-search"])]),_:1}))}});export{gt as default};
