var Q=Object.defineProperty;var q=(g,t,a)=>t in g?Q(g,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):g[t]=a;var B=(g,t,a)=>q(g,typeof t!="symbol"?t+"":t,a);import{A as H,a as R,u as K,b as X}from"./PathologistList.vue_vue_type_style_index_0_scoped_45f5ffeb_lang-FwbajLSj.js";import{d as w,c as d,j as A,e as _,u as v,w as S,h as e,t as f,f as y,D as W,b as P,n as E,Q as Z,r as F,k as tt,i as et,F as ot,l as st}from"./index-CAHFE_9E.js";import{C as T,_ as nt}from"./DiseaseList.vue_vue_type_style_index_0_scoped_2e8ef3ac_lang-CSxq79ax.js";/* empty css                                                                   */import{_ as at}from"./AccessDeniedAlert.vue_vue_type_script_setup_true_lang-DQszwtgF.js";import{F as L}from"./FormSelect-Dz8sviG5.js";import{a as rt,_ as it}from"./ClearButton.vue_vue_type_script_setup_true_lang-iqMnWNPk.js";import{R as lt}from"./RefreshIcon-CgqLp7N5.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const dt={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4"},ut={class:"bg-blue-50 p-4 rounded-md border border-blue-100"},ct={class:"flex items-end justify-between"},pt={class:"text-2xl font-bold text-blue-600"},mt={class:"text-sm text-blue-500"},bt={class:"bg-red-50 p-4 rounded-md border border-red-100"},ft={class:"flex items-end justify-between"},gt={class:"text-2xl font-bold text-red-600"},ht={class:"text-sm text-red-500"},yt={class:"bg-gray-50 p-4 rounded-md border border-gray-200"},vt={class:"flex items-end justify-between"},_t={class:"text-2xl font-bold text-gray-700"},xt={class:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6"},Ot={class:"bg-gray-50 p-4 rounded-xl border border-gray-100"},$t={class:"bg-gray-50 p-4 rounded-xl border border-gray-100"},Ft=w({__name:"OpportunitySummary",props:{datos:{},monthlyPct:{},resumen:{}},setup(g){const t=g,a=d(()=>t.resumen?t.resumen.within:t.datos.reduce((l,i)=>l+i.withinOpportunity,0)),s=d(()=>t.resumen?t.resumen.out:t.datos.reduce((l,i)=>l+i.outOfOpportunity,0)),n=d(()=>t.resumen?t.resumen.total:a.value+s.value),r=d(()=>n.value?(a.value/n.value*100).toFixed(1):"0.0"),m=d(()=>n.value?(s.value/n.value*100).toFixed(1):"0.0"),u=d(()=>{if(!t.datos.length)return null;let l=t.datos[0],i=b(l);for(const x of t.datos){const N=b(x);N>i&&(l=x,i=N)}return l});d(()=>u.value?b(u.value).toFixed(1):"0.0");function b(l){const i=l.withinOpportunity+l.outOfOpportunity;return i?l.withinOpportunity/i*100:0}const o=d(()=>[a.value,s.value]),O=d(()=>({chart:{type:"donut"},labels:["Dentro de Oportunidad","Fuera de Oportunidad"],colors:["#6ce9a6","#f97066"],legend:{position:"bottom"},plotOptions:{pie:{donut:{labels:{show:!0,total:{show:!0,label:"Total",formatter:()=>n.value}}}}},dataLabels:{formatter:l=>`${l.toFixed(1)}%`,style:{textShadow:"none",filter:"none"}},tooltip:{y:{formatter:l=>`${l} procedimientos`}}})),M=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];function I(){const i=(new Date().getMonth()+11)%12;return i<0?[]:M.slice(0,i+1)}const D=d(()=>I()),z=d(()=>[{name:"Cumplimiento",data:(()=>{const l=D.value.length;if(t.monthlyPct&&t.monthlyPct.length)return t.monthlyPct.slice(0,l).map(x=>Number(Number(x).toFixed(1)));const i=Number(r.value);return Array.from({length:l},(x,N)=>{const k=(N-l/2)/l*6,j=Math.max(0,Math.min(100,i+k));return Number(j.toFixed(1))})})()}]),Y=d(()=>({chart:{type:"line",toolbar:{show:!1}},stroke:{curve:"smooth",width:3},colors:["#0ba5ec"],xaxis:{categories:D.value},yaxis:{min:0,max:100,title:{text:"% Cumplimiento"},labels:{formatter:l=>`${l.toFixed(0)}%`}},markers:{size:5},tooltip:{y:{formatter:l=>`${l.toFixed(1)}%`}}}));return(l,i)=>{const x=W("apexchart");return _(),A(v(T),{title:"Resumen de Oportunidad"},{default:S(()=>[e("div",dt,[e("div",ut,[i[0]||(i[0]=e("h4",{class:"text-sm font-semibold text-blue-700 mb-1"},"Dentro de Oportunidad",-1)),e("div",ct,[e("span",pt,f(a.value),1),e("span",mt,f(r.value)+"%",1)])]),e("div",bt,[i[1]||(i[1]=e("h4",{class:"text-sm font-semibold text-red-700 mb-1"},"Fuera de Oportunidad",-1)),e("div",ft,[e("span",gt,f(s.value),1),e("span",ht,f(m.value)+"%",1)])]),e("div",yt,[i[3]||(i[3]=e("h4",{class:"text-sm font-semibold text-gray-700 mb-1"},"Total Procedimientos",-1)),e("div",vt,[e("span",_t,f(n.value),1),i[2]||(i[2]=e("span",{class:"text-sm text-gray-500"},"100%",-1))])])]),e("div",xt,[e("div",Ot,[i[4]||(i[4]=e("h4",{class:"text-sm font-semibold text-gray-800 mb-3"},"Distribución General",-1)),y(x,{type:"donut",height:"240",options:O.value,series:o.value},null,8,["options","series"])]),e("div",$t,[i[5]||(i[5]=e("h4",{class:"text-sm font-semibold text-gray-800 mb-3"},"Tendencia de Cumplimiento",-1)),y(x,{type:"line",height:"240",options:Y.value,series:z.value},null,8,["options","series"])])])]),_:1})}}}),St={class:"bg-white rounded-xl border border-gray-200 overflow-hidden transition-all duration-200 hover:shadow-sm"},Nt={class:"p-4 border-b border-gray-200 flex justify-between items-center"},Pt={class:"font-semibold text-gray-800"},At={class:"text-xs text-gray-500 mt-1"},Mt={class:"p-4"},kt={class:"grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4"},Ct={class:"bg-blue-50 p-3 rounded-md border border-blue-100"},Tt={class:"text-xl font-semibold text-blue-700"},wt={class:"bg-red-50 p-3 rounded-md border border-red-100"},Dt={class:"text-xl font-semibold text-red-700"},It={class:"bg-gray-50 p-3 rounded-md border border-gray-200"},zt={class:"text-xl font-semibold text-gray-700"},Yt={class:"mt-2"},jt={class:"flex justify-between text-xs text-gray-500 mb-1"},Rt={class:"w-full bg-gray-200 rounded-full h-2.5 overflow-hidden"},Vt=w({__name:"TestsOpportunityPanel",props:{prueba:{}},setup(g){const t=g,a=d(()=>t.prueba.withinOpportunity+t.prueba.outOfOpportunity),s=d(()=>a.value?Math.round(t.prueba.withinOpportunity/a.value*100):0),n=d(()=>s.value>=85?"bg-green-100 text-green-800":s.value>=70?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"),r=d(()=>s.value>=85?"bg-green-500":s.value>=70?"bg-yellow-500":"bg-red-500");return(m,u)=>(_(),P("div",St,[e("div",Nt,[e("div",null,[e("h3",Pt,f(m.prueba.name),1),e("div",At,"Código: "+f(m.prueba.code),1)]),e("div",{class:E(["text-xs font-medium px-2.5 py-1 rounded-full",n.value])},f(s.value)+"% ",3)]),e("div",Mt,[e("div",kt,[e("div",Ct,[u[0]||(u[0]=e("div",{class:"text-xs text-blue-600 mb-1"},"Dentro de Oportunidad",-1)),e("div",Tt,f(m.prueba.withinOpportunity),1)]),e("div",wt,[u[1]||(u[1]=e("div",{class:"text-xs text-red-600 mb-1"},"Fuera de Oportunidad",-1)),e("div",Dt,f(m.prueba.outOfOpportunity),1)]),e("div",It,[u[2]||(u[2]=e("div",{class:"text-xs text-gray-600 mb-1"},"Total Procedimientos",-1)),e("div",zt,f(a.value),1)])]),e("div",Yt,[e("div",jt,[e("span",null,"Tiempo de Oportunidad: "+f(m.prueba.opportunityTime),1),e("span",null,f(s.value)+"%",1)]),e("div",Rt,[e("div",{class:E(["h-2.5 rounded-full",r.value]),style:Z({width:`${s.value}%`})},null,6)])])])]))}}),Bt={class:"bg-gray-50 rounded-xl p-4 border border-gray-100"},Et={class:"h-[320px] sm:h-[380px] lg:h-[420px]"},Lt=w({__name:"PathologistsPerformancePanel",props:{datos:{}},setup(g){const t=g,a=d(()=>t.datos.map(r=>r.name)),s=d(()=>[{name:"Dentro de Oportunidad",data:t.datos.map(r=>r.withinOpportunity)},{name:"Fuera de Oportunidad",data:t.datos.map(r=>r.outOfOpportunity)}]),n=d(()=>({chart:{type:"bar",stacked:!0,toolbar:{show:!0,tools:{download:!1,selection:!1,zoom:!1,zoomin:!1,zoomout:!1,pan:!1,reset:!1}},fontFamily:"Inter, sans-serif",background:"#F9FAFB"},plotOptions:{bar:{horizontal:!1,columnWidth:"55%",borderRadius:4,dataLabels:{position:"top"}}},dataLabels:{enabled:!0,formatter:function(r,m){const u=m.dataPointIndex;if(m.seriesIndex===1){const b=s.value[0].data[u],o=s.value[1].data[u],O=b+o;return O>0?`${O}`:""}return""},style:{fontSize:"11px",fontWeight:"bold",colors:["#374151"]},offsetY:-18},stroke:{show:!0,width:2,colors:["transparent"]},xaxis:{categories:a.value,labels:{style:{fontSize:"12px",fontFamily:"Inter, sans-serif"}},axisBorder:{show:!1},axisTicks:{show:!1}},yaxis:{title:{text:"Casos asignados",style:{fontSize:"12px",fontFamily:"Inter, sans-serif"}},labels:{style:{fontSize:"12px",fontFamily:"Inter, sans-serif"}}},fill:{opacity:1},tooltip:{y:{formatter:r=>`${r} procedimientos`},theme:"light",style:{fontSize:"12px",fontFamily:"Inter, sans-serif"}},legend:{position:"top",horizontalAlign:"right",fontSize:"12px",fontFamily:"Inter, sans-serif",markers:{width:12,height:12,radius:12}},colors:["#6ce9a6","#f97066"],grid:{borderColor:"#E5E7EB",strokeDashArray:4,xaxis:{lines:{show:!1}}}}));return n.value.responsive=[{breakpoint:1280,options:{plotOptions:{bar:{columnWidth:"60%"}},legend:{position:"top"}}},{breakpoint:1024,options:{plotOptions:{bar:{columnWidth:"70%"}},legend:{position:"bottom"}}},{breakpoint:640,options:{plotOptions:{bar:{columnWidth:"80%"}},xaxis:{labels:{rotate:-45}},legend:{position:"bottom"}}}],(r,m)=>{const u=W("apexchart");return _(),A(v(T),{title:"Rendimiento de Patólogos"},{default:S(()=>[e("div",Bt,[m[0]||(m[0]=e("div",{class:"flex items-center justify-between mb-4"},[e("h4",{class:"text-md font-medium text-gray-800"},"Comparativa por patólogo")],-1)),e("div",Et,[y(u,{type:"bar",height:"100%",options:n.value,series:s.value},null,8,["options","series"])])])]),_:1})}}});class Gt{constructor(){B(this,"baseCases",H.ENDPOINTS.CASES)}async getMonthlyOpportunity(t,a){try{const s={};typeof t=="number"&&(s.month=t),typeof a=="number"&&(s.year=a);const n=await R.get(`${this.baseCases}/estadisticas-oportunidad-mensual-detalle`,{params:s}),r=(n==null?void 0:n.data)??n;return this.mapMonthlyApiToFront(r)}catch(s){console.warn("Fallo en /estadisticas-oportunidad-mensual. Se intenta fallback /estadisticas",s);try{const n=`${this.baseCases}/estadisticas`,r=await R.get(n),m=(r==null?void 0:r.data)??r;return this.mapGeneralStatsToFront(m)}catch(n){return console.error("Fallo en /estadisticas",n),{tests:[],pathologists:[]}}}}async getYearlyOpportunity(t){const a=`${this.baseCases}/oportunidad-por-mes/${t}`,s=await R.get(a),n=(s==null?void 0:s.data)??s;return Array.isArray(n==null?void 0:n.porcentaje_por_mes)?n.porcentaje_por_mes.map(r=>Number(r)):[]}mapMonthlyApiToFront(t){const a=[],s=[],n=(t==null?void 0:t.pruebas)||(t==null?void 0:t.detalle_por_prueba)||(t==null?void 0:t.procedimientos)||[];if(Array.isArray(n))for(const o of n)a.push({code:String(o.codigo||o.codigoPrueba||o.code||""),name:String(o.nombre||o.prueba||o.name||""),withinOpportunity:Number(o.dentroOportunidad||o.within||o.en_oportunidad||0),outOfOpportunity:Number(o.fueraOportunidad||o.out||o.fuera||0),opportunityTime:String(o.tiempoOportunidad||o.tiempo||o.opportunityTime||"")});const r=(t==null?void 0:t.patologos)||(t==null?void 0:t.rendimiento_patologos)||(t==null?void 0:t.pathologists)||[];if(Array.isArray(r))for(const o of r)s.push({name:String(o.nombre||o.name||o.patologo||""),withinOpportunity:Number(o.dentroOportunidad||o.within||o.en_oportunidad||0),outOfOpportunity:Number(o.fueraOportunidad||o.out||o.fuera||0),avgTime:Number(o.tiempoPromedio||o.avgTime||o.tiempo||0)});const m=Array.isArray(t==null?void 0:t.porcentaje_por_mes)?t.porcentaje_por_mes.map(o=>Number(o)):void 0,u=(t==null?void 0:t.resumen)||{},b={total:Number(u.total||0),within:Number(u.dentro||0),out:Number(u.fuera||0)};return{tests:a,pathologists:s,monthlyPct:m,summary:b}}mapGeneralStatsToFront(t){const a=[],s=(t==null?void 0:t.casos_por_patologo)||(t==null?void 0:t.by_pathologist)||{};if(s&&typeof s=="object")for(const[n,r]of Object.entries(s))a.push({name:n,withinOpportunity:Number(r),outOfOpportunity:0,avgTime:0});return{tests:[],pathologists:a}}}const G=new Gt,Wt={class:"space-y-6"},Jt={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"},Ut={class:"flex items-end gap-2"},Qt={key:1,class:"space-y-4"},qt={class:"px-2"},Ht={class:"text-xl font-bold text-brand-700"},Kt={key:0,class:"text-gray-500"},Xt={key:1,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"},Zt=w({__name:"OpportunityReport",setup(g){const t=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],a=new Date,s=a.getFullYear(),n=Array.from({length:5},(c,p)=>s-p),r=a.getMonth(),m=(r+11)%12,u=r===0?s-1:s,b=F(String(m)),o=F(String(u)),O=F(!1),M=F(!1),I=d(()=>{const c=new Date,p=c.getFullYear(),h=c.getMonth();return t.map(($,C)=>Number(o.value)===p&&C>=h?null:{value:String(C),label:$}).filter($=>$!==null)}),D=d(()=>n.map(c=>({value:String(c),label:String(c)})));tt(o,c=>{const p=new Date,h=p.getFullYear(),$=p.getMonth();if(Number(c)===h&&Number(b.value)>=$){const U=($+11)%12;b.value=String(U)}});const z=d(()=>{const c=Number(b.value);return Number.isFinite(c)&&t[c]?t[c]:""}),Y=async()=>{if(!b.value||!o.value)return;const c=new Date,p=c.getFullYear(),h=c.getMonth(),$=Number(o.value),C=Number(b.value);if($>p||$===p&&C>=h){console.warn("No se puede generar reporte para un mes futuro");return}O.value=!0;try{await J(),M.value=!0}finally{O.value=!1}},l=()=>{b.value="",o.value="",M.value=!1},i=F([]),x=F([]),N=F(null),k=d(()=>i.value),j=d(()=>x.value),V=F([]);async function J(){const c=await G.getMonthlyOpportunity(Number(b.value)+1,Number(o.value));i.value=c.tests,x.value=c.pathologists,N.value=c.summary||null;const p=Number(o.value),h=await G.getYearlyOpportunity(p);V.value=h}return(c,p)=>(_(),P("div",Wt,[y(v(T),{title:"Reporte de Oportunidades general del laboratorio",description:"Seleccione mes y año para generar el informe."},{default:S(()=>[e("div",Jt,[y(v(L),{modelValue:b.value,"onUpdate:modelValue":p[0]||(p[0]=h=>b.value=h),label:"Mes",options:I.value,placeholder:"Seleccione mes"},null,8,["modelValue","options"]),y(v(L),{modelValue:o.value,"onUpdate:modelValue":p[1]||(p[1]=h=>o.value=h),label:"Año",options:D.value,placeholder:"Seleccione año"},null,8,["modelValue","options"]),e("div",Ut,[y(v(rt),{loading:O.value,disabled:!b.value||!o.value,text:O.value?"Generando...":"Generar Informe",onClick:Y},null,8,["loading","disabled","text"]),y(v(it),{onClick:l},{icon:S(()=>[y(v(lt),{class:"w-4 h-4 mr-2"})]),default:S(()=>[p[2]||(p[2]=et(" Limpiar ",-1))]),_:1})])])]),_:1}),M.value?(_(),P("div",Qt,[e("div",qt,[e("h2",Ht,"Reporte de Oportunidad - "+f(z.value)+" "+f(o.value),1)]),y(Ft,{datos:k.value,monthlyPct:V.value,resumen:N.value||void 0},null,8,["datos","monthlyPct","resumen"]),y(Lt,{datos:j.value},null,8,["datos"]),y(v(T),{title:"Detalle por Procedimiento",description:"Paneles por prueba."},{default:S(()=>[k.value.length===0?(_(),P("div",Kt,"No hay procedimientos para el período seleccionado.")):(_(),P("div",Xt,[(_(!0),P(ot,null,st(k.value,h=>(_(),A(Vt,{key:h.code,prueba:h},null,8,["prueba"]))),128))]))]),_:1})])):(_(),A(v(T),{key:0,title:"Vista previa",description:"Selecciona un período y genera el informe."},{default:S(()=>[...p[3]||(p[3]=[e("div",{class:"text-gray-600"},'Aún no se ha generado el informe. Selecciona mes y año y presiona "Generar Informe".',-1)])]),_:1}))]))}}),te={class:"p-6"},ee={key:1,class:"space-y-6"},pe=w({__name:"OpportunityReportsView",setup(g){const t=F("Reportes de Oportunidad"),{canAccessStatistics:a}=K();return(s,n)=>(_(),A(v(X),null,{default:S(()=>[y(v(nt),{pageTitle:t.value},null,8,["pageTitle"]),e("div",te,[v(a)?(_(),P("div",ee,[y(Zt)])):(_(),A(at,{key:0}))])]),_:1}))}});export{pe as default};
