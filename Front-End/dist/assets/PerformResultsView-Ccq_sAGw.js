import{d as M,j as g,e as d,u as e,q as D,w as x,h as o,C as _e,o as he,a as be,r as h,b,g as m,f as n,i as q,t as p,I as xe,H as ye,p as we,c as O,K as Ce}from"./index-CAHFE_9E.js";import{_ as ke,u as $e,b as Ne}from"./PathologistList.vue_vue_type_style_index_0_scoped_45f5ffeb_lang-FwbajLSj.js";import{C as L,_ as Se}from"./DiseaseList.vue_vue_type_style_index_0_scoped_2e8ef3ac_lang-CSxq79ax.js";import{_ as Ee,a as Be}from"./SearchButton.vue_vue_type_script_setup_true_lang-y2wCoroa.js";/* empty css                                                                   */import{_ as U,a as Ie}from"./ClearButton.vue_vue_type_script_setup_true_lang-iqMnWNPk.js";import{_ as Pe}from"./PreviewButton.vue_vue_type_script_setup_true_lang-CTpBWkFw.js";import{_ as Re}from"./ErrorMessage.vue_vue_type_script_setup_true_lang-B0NY5YZD.js";import{a as je}from"./Notification.vue_vue_type_script_setup_true_lang-Dr_eoe6-.js";import{_ as Le}from"./ValidationAlert.vue_vue_type_script_setup_true_lang-CKSrl8Ug.js";import{c as T}from"./casesApi.service-DwGpQD03.js";import{u as Me}from"./useNotifications-DFiSmdMU.js";import{u as Ve,_ as Ye,a as ze,b as Ae,c as qe}from"./usePerformResults-DiQBAVlc.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./UserCircleIcon-DNVwMiGR.js";const Oe={class:"bg-white rounded-lg shadow-xl w-full max-w-3xl mx-auto my-8 p-6"},Ue={class:"flex items-center justify-between mb-4"},Te=["innerHTML"],De=M({__name:"PreviewModal",props:{html:{}},emits:["close"],setup(I){return(l,r)=>(d(),g(e(ke),{onClick:r[1]||(r[1]=D(v=>l.$emit("close"),["self"]))},{default:x(()=>[o("div",Oe,[o("div",Ue,[r[2]||(r[2]=o("h3",{class:"text-lg font-semibold"},"Previsualización",-1)),o("button",{class:"text-gray-500 hover:text-gray-700",onClick:r[0]||(r[0]=v=>l.$emit("close"))},"Cerrar")]),o("div",{class:"prose max-w-none",innerHTML:l.html},null,8,Te)])]),_:1}))}}),He={class:"space-y-6"},Ke={class:"grid grid-cols-1 lg:grid-cols-3 gap-6 items-start"},Fe={class:"flex items-center justify-between mb-2"},Ge={key:0,class:"text-sm text-gray-500"},Je={key:0,class:"text-blue-600"},Qe={key:1,class:"text-orange-600 italic"},We={class:"bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200 mb-4"},Xe={class:"flex flex-col md:flex-row gap-3 md:gap-4 items-stretch md:items-end"},Ze={class:"flex-1"},es={key:0,class:"mt-1 text-xs text-red-600"},ss={class:"flex gap-2 md:gap-3"},os={key:0,class:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg"},ts={class:"flex items-center"},as={class:"text-sm text-red-600"},rs={class:"flex-1 flex flex-col min-h-0 mt-0"},ls={class:"mt-3 flex flex-wrap items-center gap-3 justify-end"},is={class:"relative p-4 sm:p-5 bg-white border border-gray-200 rounded-lg shadow-sm"},ns={class:"space-y-4"},ds={class:"text-center pb-3 border-b border-gray-200"},us={class:"inline-block"},cs={class:"text-gray-500 text-sm"},ms={class:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"},ps={class:"text-gray-900 whitespace-pre-wrap break-words overflow-hidden bg-gray-50 border border-gray-200 rounded p-3 min-h-[60px] max-w-full"},fs={class:"text-gray-900 whitespace-pre-wrap break-words overflow-hidden bg-gray-50 border border-gray-200 rounded p-3 min-h-[60px] max-w-full"},gs={class:"text-gray-900 whitespace-pre-wrap break-words overflow-hidden bg-gray-50 border border-gray-200 rounded p-3 min-h-[60px] max-w-full"},vs={class:"text-gray-900 whitespace-pre-wrap break-words overflow-hidden bg-gray-50 border border-gray-200 rounded p-3 min-h-[60px] max-w-full"},_s={class:"space-y-6"},hs=M({__name:"PerformResults",props:{sampleId:{},autoSearch:{type:Boolean}},setup(I){const l=I,{loading:r,saving:v,patient:y,caseDetails:a,activeSection:$,errorMessage:w,validationMessage:P,previewData:V,isPreviewOpen:H,isDirty:K,initialize:F,previousCases:G,sections:u,canSave:J,onSaveDraft:Q,closePreview:W,onClear:X,loadCaseByCode:Z,getDiagnosisData:ee,hasDiseaseCIEO:se,primaryDiseaseCIEO:N,formatDiagnosisForReport:oe}=Ve(l.sampleId),{isPatologo:te}=$e(),S=_e(),ae=we();he(()=>{F(),l.autoSearch&&l.sampleId&&fe();const s=()=>{z()};window.addEventListener("clear-search",s),be(()=>{window.removeEventListener("clear-search",s)})}),typeof window<"u"&&window.addEventListener("beforeunload",s=>{K.value&&(s.preventDefault(),s.returnValue="")});const c=h(""),E=h(!1),_=h(!1),f=h(""),R=h(null),C=h(null),Y=s=>!s||typeof s!="string"||s.trim()===""?!1:/^\d{4}-\d{5}$/.test(s.trim()),re=()=>{if(!S.user)return null;let s=S.user.nombre||null;return s||(s=S.user.email),s},le=s=>s!=null&&s.patologo_asignado&&s.patologo_asignado.nombre||null,ie=s=>{s=s.replace(/[^\d-]/g,""),s=s.slice(0,10),s.length>=4&&!s.includes("-")&&(s=s.slice(0,4)+"-"+s.slice(4));const t=s.split("-");if(t.length>2&&(s=t[0]+"-"+t.slice(1).join("")),s.includes("-")&&s.indexOf("-")!==4){const i=s.replace(/-/g,"");i.length>=4?s=i.slice(0,4)+"-"+i.slice(4,9):s=i}c.value=s},j=async()=>{if(!c.value.trim()){f.value="Por favor, ingrese un código de caso";return}if(!Y(c.value)){f.value="El código debe tener el formato YYYY-NNNNN (Ejemplo: 2025-00001)";return}E.value=!0,f.value="",_.value=!1;try{const s=await T.getCaseByCode(c.value.trim());if(te.value&&S.user){const t=le(s),i=re();if(!t)throw new Error("Este caso no tiene un patólogo asignado.");if(!i)throw new Error("No se pudo identificar tu nombre de usuario. Contacta al administrador.");if(t!==i)throw new Error("No tienes permisos para acceder a este caso. Solo puedes acceder a casos donde estés asignado como patólogo.")}R.value=s,_.value=!0,await Z(c.value.trim())}catch(s){_.value=!1,R.value=null,f.value=s.message||"Error al buscar el caso"}finally{E.value=!1}},z=()=>{c.value="",_.value=!1,f.value="",R.value=null},{notification:k,showSuccess:ne,showError:de,closeNotification:ue}=Me();function ce(){X()}function me(){var t;const s={sampleId:((t=a==null?void 0:a.value)==null?void 0:t.CasoCode)||l.sampleId,patient:(y==null?void 0:y.value)||null,caseDetails:(a==null?void 0:a.value)||null,sections:(u==null?void 0:u.value)||null,diagnosis:{cie10:ee(),cieo:se.value&&N.value?{id:N.value.id,codigo:N.value.codigo,nombre:N.value.nombre}:void 0,formatted:oe()},generatedAt:new Date().toISOString()};try{sessionStorage.setItem("results_preview_payload",JSON.stringify(s))}catch{}ae.push({name:"results-preview"})}async function pe(){var t;if(await Q()){const i=((t=a==null?void 0:a.value)==null?void 0:t.CasoCode)||"";ne("¡Resultado guardado!",i?`Se guardó el resultado del caso ${i}.`:"Se guardó el resultado correctamente.",0)}else de("Error al guardar",(w==null?void 0:w.value)||"No se pudo guardar el resultado.",0)}const fe=async()=>{l.sampleId&&(c.value=l.sampleId,await j())},ge=s=>{u.value&&(u.value[$.value]=s)},ve=async s=>{try{const t=await T.getCaseByCode(s.CasoCode);C.value=t}catch{C.value=s}};return(s,t)=>(d(),b("div",He,[o("div",Ke,[n(e(L),{class:"lg:col-span-2 min-h-[640px] flex flex-col",dense:!1,fullHeight:!0},{default:x(()=>{var i,A;return[o("div",Fe,[t[4]||(t[4]=o("h2",{class:"text-lg font-semibold"},"Realizar Resultados",-1)),(i=e(a))!=null&&i.CasoCode?(d(),b("div",Ge,[t[2]||(t[2]=o("span",{class:"font-medium"},"Caso:",-1)),q(" "+p(e(a).CasoCode)+" ",1),t[3]||(t[3]=o("span",{class:"mx-2"},"-",-1)),(A=e(a).patologo_asignado)!=null&&A.nombre?(d(),b("span",Je,p(e(a).patologo_asignado.nombre),1)):(d(),b("span",Qe," Sin patólogo asignado "))])):m("",!0)]),o("div",We,[t[6]||(t[6]=o("h3",{class:"text-sm font-semibold text-gray-700 mb-3 flex items-center"},[o("svg",{class:"w-4 h-4 mr-2 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})]),q(" Buscar Caso ")],-1)),o("div",Xe,[o("div",Ze,[n(e(Ee),{id:"codigo-caso","model-value":c.value,"onUpdate:modelValue":ie,type:"text",placeholder:"Ej: 2025-00001",maxlength:"10",autocomplete:"off",disabled:E.value,onKeydown:xe(D(j,["prevent"]),["enter"]),class:"flex-1"},null,8,["model-value","disabled","onKeydown"]),c.value&&!Y(c.value)?(d(),b("div",es," El código debe tener el formato YYYY-NNNNN (Ejemplo: 2025-00001) ")):m("",!0)]),o("div",ss,[_.value?m("",!0):(d(),g(e(Be),{key:0,text:"Buscar","loading-text":"Buscando...",loading:E.value,onClick:j,size:"md",variant:"primary"},null,8,["loading"])),_.value?(d(),g(e(U),{key:1,text:"Limpiar",onClick:z})):m("",!0)])]),f.value?(d(),b("div",os,[o("div",ts,[t[5]||(t[5]=o("svg",{class:"w-5 h-5 text-red-500 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),o("p",as,p(f.value),1)])])):m("",!0)]),o("div",rs,[n(Ye,{class:"flex-1 min-h-0","model-value":e(u)[e($)],"onUpdate:modelValue":ge,"active-section":e($),"onUpdate:activeSection":t[0]||(t[0]=B=>$.value=B),sections:e(u)},null,8,["model-value","active-section","sections"]),n(e(Le),{visible:!!e(P),class:"mt-2",errors:e(P)?[e(P)]:[]},null,8,["visible","errors"]),e(w)?(d(),g(e(Re),{key:0,class:"mt-2",message:e(w)},null,8,["message"])):m("",!0),o("div",ls,[n(e(U),{disabled:e(r),onClick:ce},null,8,["disabled"]),n(e(Pe),{disabled:e(r),onClick:me},null,8,["disabled"]),n(e(Ie),{disabled:e(v)||e(r)||!e(J),loading:e(v),text:"Guardar","loading-text":"Guardando...",onClick:pe},null,8,["disabled","loading"])]),n(je,{class:"mt-3",visible:e(k).visible,type:e(k).type,title:e(k).title,message:e(k).message,inline:!0,"auto-close":!1,"data-notification":"success",onClose:e(ue)},ye({_:2},[e(k).type==="success"?{name:"content",fn:x(()=>{var B;return[o("div",is,[o("div",ns,[o("div",ds,[o("div",us,[t[7]||(t[7]=o("p",{class:"font-semibold text-gray-900 text-base"},"Resumen de cortes guardados",-1)),o("p",cs,"Caso "+p(((B=e(a))==null?void 0:B.CasoCode)||s.sampleId),1)])]),o("div",ms,[o("div",null,[t[8]||(t[8]=o("h5",{class:"font-medium text-gray-700 mb-1"},"Método",-1)),o("div",ps,p(e(u).method||"—"),1)]),o("div",null,[t[9]||(t[9]=o("h5",{class:"font-medium text-gray-700 mb-1"},"Corte Macro",-1)),o("div",fs,p(e(u).macro||"—"),1)]),o("div",null,[t[10]||(t[10]=o("h5",{class:"font-medium text-gray-700 mb-1"},"Corte Micro",-1)),o("div",gs,p(e(u).micro||"—"),1)]),o("div",null,[t[11]||(t[11]=o("h5",{class:"font-medium text-gray-700 mb-1"},"Diagnóstico",-1)),o("div",vs,p(e(u).diagnosis||"—"),1)])])])])]}),key:"0"}:void 0]),1032,["visible","type","title","message","onClose"])])]}),_:1}),o("div",_s,[n(e(L),null,{default:x(()=>[n(ze,{patient:e(y),loading:e(r),"previous-cases":e(G),onCaseClick:ve},null,8,["patient","loading","previous-cases"])]),_:1}),n(e(L),null,{default:x(()=>[n(Ae,{details:e(a),loading:e(r)},null,8,["details","loading"])]),_:1})])]),e(H)&&e(V)?(d(),g(De,{key:0,html:e(V).html,onClose:e(W)},null,8,["html","onClose"])):m("",!0),C.value?(d(),g(qe,{key:1,"case-item":C.value,onClose:t[1]||(t[1]=i=>C.value=null)},null,8,["case-item"])):m("",!0)]))}}),bs="Realizar Resultados",Ms=M({__name:"PerformResultsView",setup(I){const l=Ce(),r=O(()=>l.query.muestraId||l.query.case||""),v=O(()=>l.query.auto==="1"&&!!r.value);return(y,a)=>(d(),g(e(Ne),null,{default:x(()=>[n(Se,{pageTitle:bs}),n(e(hs),{"sample-id":r.value,"auto-search":v.value},null,8,["sample-id","auto-search"])]),_:1}))}});export{Ms as default};
