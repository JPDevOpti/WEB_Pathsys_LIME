var W=Object.defineProperty;var X=(n,t,s)=>t in n?W(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var j=(n,t,s)=>X(n,typeof t!="symbol"?t+"":t,s);import{A as Y,a as N,u as Z}from"./PathologistList.vue_vue_type_style_index_0_scoped_45f5ffeb_lang-FwbajLSj.js";import{c as z}from"./casesApi.service-DwGpQD03.js";import{r as y,d as ee,C as te,c as E,k as A,o as ae,b as u,e as i,g as x,h as c,i as se,t as D,n as $,u as F,F as oe,l as re,v as I}from"./index-CAHFE_9E.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";class ne{constructor(){j(this,"endpoint",Y.ENDPOINTS.PATHOLOGISTS)}async getPathologists(){try{const t=await N.get(this.endpoint,{params:{skip:0,limit:100}});return this.transformPathologistsResponse(t)}catch(t){throw console.error("Error al obtener patólogos:",t),new Error(t.message||"Error al obtener la lista de patólogos")}}async getPathologist(t){try{const s=await N.get(`${this.endpoint}/${t}`);return this.transformPathologistResponse(s)}catch(s){throw console.error(`Error al obtener patólogo ${t}:`,s),new Error(s.message||`Error al obtener el patólogo ${t}`)}}async searchPathologists(t){try{const s=await N.get(`${this.endpoint}/buscar`,{params:{query:t}});return this.transformPathologistsResponse(s)}catch(s){return console.error(`Error al buscar patólogos con query "${t}":`,s),[]}}generateInitials(t){return t.replace(/\b(Dr\.?|Dra\.?|Doctor|Doctora)\b\s*/gi,"").trim().split(/\s+/).filter(P=>P.length>0).map(P=>P[0].toUpperCase()).join("").slice(0,10)||"N/A"}transformPathologistsResponse(t){return t.map(s=>this.transformPathologistResponse(s))}transformPathologistResponse(t){return{id:t.id||t._id||t.patologoCode,nombre:t.patologoName,iniciales:t.InicialesPatologo||this.generateInitials(t.patologoName),documento:t.patologoCode,email:t.PatologoEmail||"",medicalLicense:t.registro_medico,isActive:t.isActive??!0}}}const U=new ne;function ue(){const n=y(!1),t=y(""),s=y([]),g=async()=>{n.value=!0,t.value="";try{const o=await U.getPathologists();return s.value=o,{success:!0,pathologists:o}}catch(o){return t.value=o.message||"Error al cargar la lista de patólogos",{success:!1,message:t.value,pathologists:[]}}finally{n.value=!1}},h=async o=>{if(!o.trim())return await g();n.value=!0,t.value="";try{const r=await U.searchPathologists(o);return s.value=r,{success:!0,pathologists:r}}catch(r){return t.value=r.message||"Error al buscar patólogos",{success:!1,message:t.value,pathologists:[]}}finally{n.value=!1}},P=async(o,r)=>{var l,p;n.value=!0,t.value="";try{if(s.value.length===0){const C=await g();if(!C.success)throw new Error("No se pudieron cargar los patólogos: "+C.message)}const m=k(r.patologoId);if(!m)throw new Error("Patólogo no encontrado en la lista local");const d=v(m);return await z.assignPathologist(o,d),{success:!0,message:"Patólogo asignado exitosamente",assignment:{isAssigned:!0,assignedDate:r.fechaAsignacion,pathologist:m}}}catch(m){return t.value=((p=(l=m.response)==null?void 0:l.data)==null?void 0:p.detail)||m.message||"Error al asignar el patólogo",{success:!1,message:t.value}}finally{n.value=!1}},T=async o=>{var r,l;n.value=!0,t.value="";try{return await z.unassignPathologist(o),{success:!0,message:"Patólogo desasignado exitosamente",assignment:{isAssigned:!1}}}catch(p){return t.value=((l=(r=p.response)==null?void 0:r.data)==null?void 0:l.detail)||p.message||"Error al desasignar el patólogo",{success:!1,message:t.value}}finally{n.value=!1}},k=o=>s.value.find(l=>l.documento===o),v=o=>({codigo:o.documento,nombre:o.nombre});return{isLoading:n,error:t,pathologists:s,loadPathologists:g,searchPathologists:h,assignPathologist:P,unassignPathologist:T,clearState:()=>{t.value="",n.value=!1}}}const ie={class:"pathologist-combobox"},ce={key:0,class:"block text-sm font-medium text-gray-700 mb-1"},de={key:0,class:"text-red-500 ml-1"},ve={class:"relative"},ge={class:"relative"},me=["value","placeholder","disabled"],pe={key:0,class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},fe={key:1,class:"absolute inset-y-0 right-0 pr-3 flex items-center"},he={key:1,class:"h-4 w-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},be={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},ye={key:0,class:"px-3 py-2 text-sm text-gray-500 text-center"},we={key:1,class:"px-3 py-2 text-sm text-gray-500 text-center"},xe=["onClick","onMouseenter"],Pe={class:"flex items-center justify-between"},ke={key:0,class:"h-4 w-4 text-blue-600",fill:"currentColor",viewBox:"0 0 20 20"},_e={key:1,class:"mt-1 text-xs text-gray-500"},Ce={key:2,class:"mt-1 text-xs text-blue-600"},Ee={key:3,class:"mt-1 text-sm text-red-600"},Ae={key:4,class:"mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg"},Le=ee({__name:"PathologistList",props:{modelValue:{default:""},label:{default:""},placeholder:{default:"Buscar y seleccionar patólogo..."},required:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},helpText:{default:""},errors:{default:()=>[]},autoLoad:{type:Boolean,default:!0}},emits:["update:modelValue","pathologist-selected","load-error","load-success"],setup(n,{emit:t}){const s=n,g=t,{pathologists:h,loadPathologists:P,isLoading:T}=ue(),{isPatologo:k}=Z(),v=te(),_=y(),o=y(""),r=y(!1),l=y(-1),p=y(""),m=y(!1),d=y(s.modelValue),B=E(()=>Array.isArray(s.errors)?s.errors.join(", "):""),C=E(()=>h.value.map(e=>({value:e.documento,label:e.iniciales?`${e.iniciales} - ${e.nombre}`:e.nombre,pathologist:e}))),L=E(()=>{if(!o.value.trim())return C.value;const e=o.value.toLowerCase().trim();return C.value.filter(a=>{const f=a.label.toLowerCase(),b=a.pathologist;return f.includes(e)||b.nombre.toLowerCase().includes(e)||b.iniciales&&b.iniciales.toLowerCase().includes(e)||b.documento.toLowerCase().includes(e)})}),M=E(()=>{if(!d.value)return null;const e=C.value.find(a=>a.value===d.value);return(e==null?void 0:e.pathologist)||null}),R=E(()=>{if(m.value)return o.value;if(d.value&&M.value){const e=M.value;return e.iniciales?`${e.iniciales} - ${e.nombre}`:e.nombre}return o.value}),q=()=>{w.value||(m.value=!0,o.value="",r.value=!0,l.value=-1)},G=()=>{setTimeout(()=>{m.value=!1,r.value=!1,d.value||(o.value="")},150)},H=()=>{var e,a;s.disabled||w.value||(r.value?(e=_.value)==null||e.blur():(a=_.value)==null||a.focus())},K=e=>{if(w.value)return;const a=e.target;o.value=a.value,o.value.trim()&&(r.value=!0,l.value=-1)},V=e=>{var a;w.value||(d.value=e.value,o.value="",r.value=!1,l.value=-1,g("update:modelValue",e.value),g("pathologist-selected",e.pathologist),(a=_.value)==null||a.blur())},Q=e=>{var a;if(!(s.disabled||w.value))switch(e.key){case"ArrowDown":e.preventDefault(),r.value||(r.value=!0),l.value=Math.min(l.value+1,L.value.length-1);break;case"ArrowUp":e.preventDefault(),r.value&&(l.value=Math.max(l.value-1,-1));break;case"Enter":e.preventDefault(),r.value&&l.value>=0&&L.value[l.value]&&V(L.value[l.value]);break;case"Escape":e.preventDefault(),r.value=!1,l.value=-1,(a=_.value)==null||a.blur();break;case"Tab":r.value=!1;break}},w=E(()=>k.value&&v.userRole!=="administrador"),S=()=>{if((k.value||v.userRole==="administrador")&&v.user&&!d.value){const a=v.user.nombre||v.user.nombres||v.user.nombre_completo||v.user.full_name||v.user.username||"";if(a&&h.value.length>0){const f=h.value.find(b=>b.nombre&&b.nombre.toLowerCase().includes(a.toLowerCase()));f&&(d.value=f.documento,g("update:modelValue",f.documento),g("pathologist-selected",f))}}},O=async()=>{try{p.value="";const e=await P();e.success?(g("load-success",h.value),I(()=>{S()})):(p.value=e.message||"Error al cargar patólogos",g("load-error",p.value))}catch(e){const a="Error al cargar la lista de patólogos";p.value=a,g("load-error",a),console.error("Error al recargar patólogos:",e)}};return A(()=>s.modelValue,e=>{d.value=e||""},{immediate:!0}),A(d,e=>{e!==s.modelValue&&g("update:modelValue",e)}),A(h,e=>{const a=k.value||v.userRole==="administrador";e.length>0&&a&&!d.value&&I(()=>{S()})},{immediate:!0}),A([()=>v.user,()=>k.value,()=>v.userRole],()=>{const e=k.value||v.userRole==="administrador";h.value.length>0&&e&&!d.value&&I(()=>{S()})},{immediate:!0}),A(o,()=>{m.value&&o.value.trim()&&(r.value=!0,l.value=-1)}),ae(async()=>{s.autoLoad&&h.value.length===0&&await O()}),A([R,m],()=>{m.value||I(()=>{o.value=R.value})}),(e,a)=>(i(),u("div",ie,[e.label?(i(),u("label",ce,[se(D(e.label)+" ",1),e.required?(i(),u("span",de,"*")):x("",!0)])):x("",!0),c("div",ve,[c("div",ge,[c("input",{ref_key:"inputRef",ref:_,value:R.value,type:"text",placeholder:e.placeholder,disabled:e.disabled||w.value,class:$(["w-full px-3 py-2 pr-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-colors bg-white appearance-none",B.value?"border-red-300 focus:ring-red-500 focus:border-red-500":"border-gray-300",e.disabled||w.value?"bg-gray-50 text-gray-500 cursor-not-allowed":"text-gray-900"]),onFocus:q,onBlur:G,onInput:K,onKeydown:Q,autocomplete:"off"},null,42,me),F(T)?(i(),u("div",pe,[...a[0]||(a[0]=[c("svg",{class:"animate-spin h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24"},[c("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),c("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)])])):(i(),u("div",fe,[w.value?(i(),u("svg",he,[...a[2]||(a[2]=[c("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])])):(i(),u("svg",{key:0,class:$(["h-4 w-4 text-gray-400 cursor-pointer transition-transform",{"transform rotate-180":r.value}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",onClick:H},[...a[1]||(a[1]=[c("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))]))]),r.value&&!e.disabled?(i(),u("div",be,[F(T)?(i(),u("div",ye," Cargando patólogos... ")):L.value.length===0?(i(),u("div",we,D(o.value.trim()?"No se encontraron patólogos":"No hay patólogos disponibles"),1)):x("",!0),(i(!0),u(oe,null,re(L.value,(f,b)=>(i(),u("div",{key:f.value,class:$(["px-3 py-2 text-sm cursor-pointer transition-colors",b===l.value?"bg-blue-50 text-blue-900":"text-gray-900 hover:bg-gray-100",d.value===f.value?"bg-blue-100 text-blue-900 font-medium":""]),onClick:J=>V(f),onMouseenter:J=>l.value=b},[c("div",Pe,[c("span",null,D(f.label),1),d.value===f.value?(i(),u("svg",ke,[...a[3]||(a[3]=[c("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)])])):x("",!0)])],42,xe))),128))])):x("",!0)]),e.helpText?(i(),u("p",_e,D(e.helpText),1)):x("",!0),w.value?(i(),u("p",Ce," Tu patólogo está pre-seleccionado automáticamente ")):x("",!0),B.value?(i(),u("p",Ee,D(B.value),1)):x("",!0),p.value?(i(),u("div",Ae,[c("div",{class:"flex items-center"},[a[5]||(a[5]=c("svg",{class:"w-5 h-5 text-amber-600 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[c("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),c("div",null,[a[4]||(a[4]=c("p",{class:"text-sm text-amber-800"},"No se pudieron cargar los patólogos.",-1)),c("button",{onClick:O,class:"mt-1 text-sm text-amber-700 hover:text-amber-800 underline font-medium"}," Intentar cargar nuevamente ")])])])):x("",!0)]))}}),Se=le(Le,[["__scopeId","data-v-45f5ffeb"]]);export{Se as P,ue as u};
