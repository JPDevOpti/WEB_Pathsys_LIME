import{d as F,c as O,r as b,o as Q,v as ye,b as k,g as H,h as f,f as w,u as y,F as U,l as me,R as z,e as _,j as he,t as ve,p as Fe}from"./index-CAHFE_9E.js";import{h as Be}from"./html2pdf-I8xnP9zX.js";import{_ as Te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Le={key:0,class:"p-4 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800 print-hidden"},Me={class:"print-hidden",style:{position:"absolute",left:"-10000px",top:"0",opacity:"0","pointer-events":"none",overflow:"visible"}},Ee={key:1,class:"pdf-preview-container"},He={key:0,class:"print-content"},Ne={class:"content-area"},Ae=["innerHTML"],je={class:"footer-container"},Oe={key:1,class:"print-content"},ze={class:"content-area"},qe=["innerHTML"],Ve={class:"footer-container"},Ge=F({__name:"PDFReportPreview",props:{payload:{}},emits:["all-signatures-loaded"],setup(ee,{emit:W}){const x=F({name:"PDFReportHeader",setup(){return()=>z("div")}}),C=F({name:"PDFReportDeptInfo",props:["caseItem","formatDate","recibidoNumero"],setup(){return()=>z("div")}}),N=F({name:"PDFReportPatientBlock",props:["caseItem","recibidoNumero"],setup(){return()=>z("div")}}),B=F({name:"PDFReportSignature",emits:["signature-loaded"],props:["caseItem"],setup(e,{emit:a}){return Q(()=>a("signature-loaded",!0)),()=>z("div")}}),T=F({name:"PDFReportFooter",props:["page","total"],setup(){return()=>z("div")}}),p=ee,X=W,L=O(()=>{var e,a,n;return!!((e=p.payload)!=null&&e.multipleCases&&((a=p.payload)!=null&&a.cases)&&((n=p.payload)!=null&&n.cases.length))}),R=O(()=>{var e,a,n,t;return p.payload?L.value?!!((e=p.payload)!=null&&e.cases&&((a=p.payload)!=null&&a.cases.length)):!!((n=p.payload)!=null&&n.caseDetails||(t=p.payload)!=null&&t.sections):!1}),P=O(()=>{var e,a,n,t,o,s;return{sampleId:(e=p.payload)==null?void 0:e.sampleId,patient:(a=p.payload)==null?void 0:a.patient,caseDetails:(n=p.payload)==null?void 0:n.caseDetails,sections:((t=p.payload)==null?void 0:t.sections)||void 0,diagnosis:((o=p.payload)==null?void 0:o.diagnosis)||void 0,generatedAt:(s=p.payload)==null?void 0:s.generatedAt}}),S={width:"8.5in",height:"11in",padding:"0.5in 0.5in 0.3in 0.5in",boxSizing:"border-box",color:"#111827",overflow:"hidden"};function v(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function i(e){var ie,le,ce,de,ue,pe,ge,fe;const a=[],n=v(Pe((ie=e.caseDetails)==null?void 0:ie.muestras)),t=v(((le=e.sections)==null?void 0:le.macro)||"—"),o=v(((ce=e.sections)==null?void 0:ce.micro)||"—"),s=v(((de=e.sections)==null?void 0:de.method)||"—"),d=c=>(c==null?void 0:c.codigo)??(c==null?void 0:c.code)??(c==null?void 0:c.cod)??(c==null?void 0:c.id),r=c=>(c==null?void 0:c.nombre)??(c==null?void 0:c.name)??(c==null?void 0:c.descripcion)??(c==null?void 0:c.description),l=((ue=e.diagnosis)==null?void 0:ue.cie10)||{},u=(l==null?void 0:l.primary)||l,D=d(u),A=r(u),j=v(D??"—"),K=A?` - ${v(A)}`:"",$=((pe=e.diagnosis)==null?void 0:pe.cieo)||{},oe=($==null?void 0:$.primary)||$,ke=d(oe),re=r(oe),Se=v(ke??"—"),Ie=re?` - ${v(re)}`:"",Re=(((ge=e.sections)==null?void 0:ge.diagnosis)??"").toString().trim(),Ce=(((fe=e.diagnosis)==null?void 0:fe.formatted)??"").toString().trim(),De=v(Re||Ce||"—");a.push(`<strong>MUESTRA:</strong><br/>${n}`),a.push(`<br/><strong>DESCRIPCIÓN MACROSCÓPICA</strong><br/>${t}`),a.push(`<br/><strong>DESCRIPCIÓN MICROSCÓPICA</strong><br/>${o}`),a.push(`<br/><strong>MÉTODO UTILIZADO</strong><br/>${s}`);const $e=["<br/><strong>DIAGNÓSTICO</strong>",De,`<div style="margin-top:14px"><strong>CIE-10:</strong> ${j}${K}</div>`,`<div style="margin-top:0px"><strong>CIE-O:</strong> ${Se}${Ie}</div>`].join("<br/>");return a.push($e),a.join("<br/>")}const g=b(null),J=b(null),q=b(null),V=b(null),M=b(0),I=b(0),m=b(0),h=b(0),G=b(0),be=b(!1);Q(async()=>{var r,l,u,D;await ye();const e=11*96,a=.5*96,n=.3*96,t=((r=J.value)==null?void 0:r.scrollHeight)||0,o=((l=q.value)==null?void 0:l.scrollHeight)||0,s=((u=V.value)==null?void 0:u.scrollHeight)||0,d=Math.max(0,e-a-n);M.value=Math.max(0,d-t-o),I.value=Math.max(0,d-o),m.value=s,L.value&&((D=p.payload)!=null&&D.cases)?G.value=p.payload.cases.length:G.value=1});const te=e=>{h.value++,console.log(`📝 Firma ${h.value}/${G.value} cargada`),h.value>=G.value&&(be.value=!0,console.log("✅ Todas las firmas han sido cargadas"),X("all-signatures-loaded"))};function we(e,a,n){if(!e)return[""];const t=e.split(/<br\/>/),o=[];let s=[];const d=u=>g.value?(g.value.innerHTML=u,g.value.scrollHeight):0,r=()=>{const u=s.join("<br/>");o.push(u),s=[]};let l=a||0;for(let u=0;u<t.length;u+=1){const D=s.length?s.join("<br/>")+"<br/>"+t[u]:t[u];if(d(D)<=(l||Number.MAX_SAFE_INTEGER))s.push(t[u]);else{if(s.length>0){const K=s.join("<br/>"),$=_e(K,t[u],l);if($.fit){s.push($.fit),r(),l=n||0,$.rest&&s.push($.rest);continue}}const j=ae(t[u],l);s.push(j.fit),r(),l=n||0,j.rest&&s.push(j.rest)}}return s.length&&r(),o}function ae(e,a){if(!g.value||!a)return{fit:e,rest:""};let n=0,t=e.length,o=0;for(;n<=t;){const r=Math.floor((n+t)/2);g.value.innerHTML=e.slice(0,r),g.value.scrollHeight<=a?(o=r,n=r+1):t=r-1}const s=e.slice(0,o),d=e.slice(o);return{fit:s,rest:d}}function _e(e,a,n){if(!g.value||!n)return{fit:"",rest:a};let t=0,o=a.length,s=0;for(;t<=o;){const l=Math.floor((t+o)/2),u=(e?e+"<br/>":"")+a.slice(0,l);g.value.innerHTML=u,g.value.scrollHeight<=n?(s=l,t=l+1):o=l-1}const d=a.slice(0,s),r=a.slice(s);return{fit:d,rest:r}}function ne(e){return M.value>0&&I.value>0?we(e,M.value,I.value):[e]}function se(e,a,n){if(!e.length||!g.value||!a||!n)return e;let t=e[e.length-1];const o=Math.max(0,a-n),s=d=>(g.value.innerHTML=d,g.value.scrollHeight);for(;s(t)>o;){const d=ae(t,o);if(e[e.length-1]=d.fit,d.rest)e.push(d.rest),t=e[e.length-1];else break}return e}const xe=O(()=>{var n;if(!L.value||!((n=p.payload)!=null&&n.cases))return[];const e={};p.payload.cases.forEach((t,o)=>{var d,r,l;const s=((d=t.patient)==null?void 0:d.document)||((l=(r=t.caseDetails)==null?void 0:r.paciente)==null?void 0:l.cedula)||`unknown_${o}`;e[s]||(e[s]=[]),e[s].push({case:t,originalIndex:o})});const a=[];return Object.values(e).forEach(t=>{const o=t.map(r=>{const l=ne(i(r.case)),D=l.length===1?M.value:I.value,A=se([...l],D,m.value);return{originalIndex:r.originalIndex,case:r.case,chunks:A}}),s=o.reduce((r,l)=>r+l.chunks.length,0);let d=1;o.forEach(r=>{r.chunks.forEach((l,u)=>{a.push({case:r.case,pageNumber:d,totalPagesForPatient:s,originalIndex:r.originalIndex,pageIndex:u,pageContent:l,isLastPage:u===r.chunks.length-1}),d+=1})})}),a.sort((t,o)=>t.originalIndex-o.originalIndex||t.pageIndex-o.pageIndex)}),Y=O(()=>{const e=i(P.value),a=ne(e),n=a.length===1?M.value:I.value;return se(a,n,m.value)});function E(e){if(!e)return null;const a=String(e).split("-");return a.length<2?e:a.slice(1).join("-")}function Pe(e){return!e||e.length===0?"—":e.map(a=>{var n;return`${a.region_cuerpo}: ${(n=a.pruebas)==null?void 0:n.map(t=>t.id===t.nombre?t.id:`${t.id} - ${t.nombre}`).join(", ")}`}).join(" | ")}function Z(e){if(!e)return null;try{const a=new Date(e),n=a.toLocaleDateString("es-CO",{year:"numeric",month:"2-digit",day:"2-digit"}),t=a.toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"});return`${n} ${t}`}catch{return null}}return(e,a)=>(_(),k("div",null,[R.value?H("",!0):(_(),k("div",Le," No hay datos para previsualizar. ")),f("div",Me,[f("div",{ref_key:"measureBodyRef",ref:g,style:{width:"8.5in","font-size":"12px","line-height":"1.35","white-space":"pre-wrap","word-break":"break-word","overflow-wrap":"anywhere"}},null,512),f("div",{ref_key:"measureHeaderRef",ref:J,style:{width:"8.5in","box-sizing":"border-box"}},[f("div",null,[w(y(x)),w(y(C),{"case-item":P.value,"format-date":Z,"recibido-numero":E},null,8,["case-item"]),w(y(N),{"case-item":P.value,"recibido-numero":E},null,8,["case-item"])])],512),f("div",{ref_key:"measureFooterRef",ref:q,style:{width:"8.5in","box-sizing":"border-box"}},[w(y(T),{page:1,total:1})],512),f("div",{ref_key:"measureSignatureRef",ref:V,style:{width:"8.5in","box-sizing":"border-box"}},[w(y(B),{"case-item":P.value},null,8,["case-item"])],512)]),R.value?(_(),k("div",Ee,[L.value?(_(),k("div",He,[(_(!0),k(U,null,me(xe.value,(n,t)=>(_(),k("div",{key:`${n.originalIndex}-${n.pageIndex}`,class:"bg-white mx-auto shadow-sm border border-gray-200 report-page",style:S},[n.pageIndex===0?(_(),k(U,{key:0},[w(y(x)),w(y(C),{"case-item":n.case,"format-date":Z,"recibido-numero":E},null,8,["case-item"]),w(y(N),{"case-item":n.case,"recibido-numero":E},null,8,["case-item"])],64)):H("",!0),f("div",Ne,[f("div",{class:"wrap body-text",style:{"white-space":"pre-wrap"},innerHTML:n.pageContent},null,8,Ae)]),n.isLastPage?(_(),he(y(B),{key:1,"case-item":n.case,onSignatureLoaded:te},null,8,["case-item"])):H("",!0),f("div",je,[w(y(T),{page:n.pageNumber,total:n.totalPagesForPatient},null,8,["page","total"])])]))),128))])):(_(),k("div",Oe,[(_(!0),k(U,null,me(Y.value,(n,t)=>(_(),k("div",{key:t,class:"bg-white mx-auto shadow-sm border border-gray-200 report-page",style:S},[t===0?(_(),k(U,{key:0},[w(y(x)),w(y(C),{"case-item":P.value,"format-date":Z,"recibido-numero":E},null,8,["case-item"]),w(y(N),{"case-item":P.value,"recibido-numero":E},null,8,["case-item"])],64)):H("",!0),f("div",ze,[f("div",{class:"wrap body-text",style:{"white-space":"pre-wrap"},innerHTML:n},null,8,qe)]),t===Y.value.length-1?(_(),he(y(B),{key:1,"case-item":P.value,onSignatureLoaded:te},null,8,["case-item"])):H("",!0),f("div",Ve,[w(y(T),{page:t+1,total:Y.value.length},null,8,["page","total"])])]))),128))]))])):H("",!0)]))}}),Ue={class:"preview-container"},We={class:"controls-section print-hidden"},Xe={class:"flex items-center justify-between mb-4"},Je={class:"text-lg font-semibold"},Ye={class:"flex gap-2"},Ze=["disabled"],Ke=F({__name:"PreviewReportView",setup(ee){const W=Fe(),x=b(null),C=b(!1),N=b(null),B=b(null),T=b(!1);Q(()=>{try{const R=localStorage.getItem("results_preview_payload"),P=R?null:sessionStorage.getItem("results_preview_payload"),S=R||P;x.value=S?JSON.parse(S):null}catch{x.value=null}});function p(){W.back()}function X(){T.value=!0,console.log("✅ Todas las firmas están listas para la impresión")}async function L(){var R,P,S,v;if(!C.value)try{C.value=!0,await ye(),T.value||(console.log("⏳ Esperando a que las firmas se carguen..."),await new Promise(I=>setTimeout(I,1e3)));const i=(R=B.value)==null?void 0:R.querySelector(".print-content");if(!i)throw new Error("No se encontró el contenido para exportar");const g={margin:i.style.margin,padding:i.style.padding,position:i.style.position,left:i.style.left,top:i.style.top};i.style.margin="0",i.style.padding="0",i.style.position="relative",i.style.left="0",i.style.top="0",i.querySelectorAll(".report-page").forEach((I,m)=>{const h=I;h.style.margin="0",h.style.marginBottom="0",h.style.marginTop="0",h.style.padding="0.5in 0.5in 0.3in 0.5in",h.style.boxSizing="border-box",h.style.width="8.5in",h.style.height="11in",h.style.pageBreakAfter="auto",h.style.breakAfter="auto",h.style.pageBreakBefore="auto",h.style.breakBefore="auto",h.style.pageBreakInside="avoid",h.style.breakInside="avoid"}),console.log("📄 Encontrado contenido para exportar:",i),console.log("📄 Contenido HTML:",i.innerHTML.substring(0,200)+"...");const q=(S=(P=x.value)==null?void 0:P.cases)!=null&&S.length?`informes_${x.value.cases.length}_casos.pdf`:`informe_${((v=x.value)==null?void 0:v.sampleId)||"caso"}.pdf`,V={margin:[0,0,0,0],filename:q,image:{type:"jpeg",quality:.98},html2canvas:{scale:1.5,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",logging:!0,removeContainer:!1,x:0,y:0,scrollX:0,scrollY:0,width:void 0,height:void 0,windowWidth:816,windowHeight:1056},jsPDF:{unit:"in",format:"letter",orientation:"portrait",compress:!0,putOnlyUsedFonts:!0}};console.log("🔄 Generando PDF..."),await Be().from(i).set(V).save(),console.log("✅ PDF generado exitosamente"),i.style.margin=g.margin,i.style.padding=g.padding,i.style.position=g.position,i.style.left=g.left,i.style.top=g.top,i.querySelectorAll(".report-page").forEach(I=>{const m=I;m.style.margin="",m.style.marginBottom="",m.style.marginTop="",m.style.padding="",m.style.boxSizing="",m.style.width="",m.style.height="",m.style.pageBreakAfter="",m.style.breakAfter="",m.style.pageBreakBefore="",m.style.breakBefore="",m.style.pageBreakInside="",m.style.breakInside=""})}catch(i){console.error("Error generando PDF:",i),alert("Error al generar el PDF. Por favor, inténtalo de nuevo.")}finally{C.value=!1}}return(R,P)=>{var S,v,i;return _(),k("div",Ue,[f("div",We,[f("div",Xe,[f("h1",Je,ve((S=x.value)!=null&&S.multipleCases&&((i=(v=x.value)==null?void 0:v.cases)!=null&&i.length)?`Previsualización de ${x.value.cases.length} Informes`:"Previsualización de Informe"),1),f("div",Ye,[f("button",{class:"px-3 py-2 text-sm rounded border border-gray-300 bg-white hover:bg-gray-100 disabled:opacity-60",disabled:C.value,onClick:L},ve(C.value?"Generando PDF…":"Descargar PDF"),9,Ze),f("button",{class:"px-3 py-2 text-sm rounded border border-gray-300 bg-white hover:bg-gray-100",onClick:p},"Volver")])])]),f("div",{ref_key:"previewContainer",ref:B,class:"pdf-container"},[w(Ge,{payload:x.value,ref_key:"pdfPreviewRef",ref:N,onAllSignaturesLoaded:X},null,8,["payload"])],512)])}}}),at=Te(Ke,[["__scopeId","data-v-2545e8cd"]]);export{at as default};
